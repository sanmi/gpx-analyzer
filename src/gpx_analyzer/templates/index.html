
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if result and result.name %}{{ result.name }} | {% endif %}Reality Check my Route</title>

    <!-- Open Graph meta tags for link previews -->
    {% set base_url = request.url_root | replace('http://', 'https://') %}
    <meta property="og:site_name" content="Reality Check my Route">
    {% if result %}
    <meta property="og:title" content="Reality Check: {{ result.name or ('Trip Analysis' if is_trip else 'Route Analysis') }}">
    {% if is_trip %}
    <meta property="og:description" content="{{ result.time_str }}{% if result.work_kj is not none %} • {{ '%.0f'|format(result.work_kj) }} kJ{% endif %} | {{ '%.0f'|format(result.distance_km) }} km • {{ '%.0f'|format(result.elevation_m) }}m{% if result.avg_watts is not none %} @ {{ result.avg_watts|int }}W{% endif %}">
    {% else %}
    <meta property="og:description" content="{{ result.time_str }} • {{ '%.0f'|format(result.work_kj) }} kJ | {{ '%.0f'|format(result.distance_km) }} km • {{ '%.0f'|format(result.elevation_m) }}m @ {{ climbing_power|int }}W">
    {% endif %}
    <meta property="og:image" content="{{ base_url }}og-image?url={{ url|urlencode }}&climbing_power={{ climbing_power }}&flat_power={{ flat_power }}&mass={{ mass }}&headwind={{ headwind }}">
    <meta property="og:type" content="website">
    {% else %}
    <meta property="og:title" content="Reality Check my Route">
    <meta property="og:description" content="Physics-based cycling time and energy estimates from elevation, surface, and rider parameters">
    <meta property="og:image" content="{{ base_url }}og-image">
    <meta property="og:type" content="website">
    {% endif %}
    <meta property="og:url" content="{{ request.url | replace('http://', 'https://') }}">

    <!-- PWA meta tags -->
    <meta name="theme-color" content="#FF6B35">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GPX Analyzer">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/apple-touch-icon.png') }}">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    {% if umami_website_id %}
    <script defer src="{{ umami_script_url }}" data-website-id="{{ umami_website_id }}"></script>
    {% endif %}
    <script defer src="{{ url_for('static', filename='js/sw-register.js') }}"></script>
</head>
<body>
    <div class="header-section">
        <div class="logo-container">
            <svg class="logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="mountainGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#FF6B35"/>
                        <stop offset="100%" style="stop-color:#F7931E"/>
                    </linearGradient>
                </defs>
                <!-- Mountain range -->
                <path d="M0 85 L25 45 L40 60 L60 30 L80 50 L100 85 Z" fill="url(#mountainGrad)"/>
                <!-- Snow caps -->
                <path d="M60 30 L67 42 L53 42 Z" fill="white" opacity="0.85"/>
                <path d="M25 45 L30 52 L20 52 Z" fill="white" opacity="0.7"/>
                <!-- Cyclist climbing - positioned on left slope -->
                <g transform="translate(18, 50) rotate(-20) scale(1.5)">
                    <!-- Wheels -->
                    <circle cx="0" cy="14" r="7" fill="none" stroke="#2D3047" stroke-width="1.5"/>
                    <circle cx="22" cy="14" r="7" fill="none" stroke="#2D3047" stroke-width="1.5"/>
                    <!-- Diamond frame -->
                    <path d="M0 14 L8 6 L18 6 L22 14 M8 6 L11 14 L18 6 M11 14 L0 14"
                          fill="none" stroke="#2D3047" stroke-width="1.5" stroke-linejoin="round"/>
                    <!-- Seat post -->
                    <line x1="8" y1="6" x2="7" y2="3" stroke="#2D3047" stroke-width="1.5"/>
                    <!-- Rider - aggressive climbing posture, bent forward -->
                    <line x1="7" y1="3" x2="14" y2="-1" stroke="#2D3047" stroke-width="2" stroke-linecap="round"/>
                    <!-- Head - tucked forward -->
                    <circle cx="16" cy="-2" r="2.5" fill="#2D3047"/>
                    <!-- Arms down to drops -->
                    <line x1="12" y1="-1" x2="18" y2="5" stroke="#2D3047" stroke-width="1.5" stroke-linecap="round"/>
                </g>
            </svg>
            <h1>Reality Check my Route</h1>
        </div>
        <p class="tagline">Physics-based cycling time and energy estimates from elevation, surface, and rider parameters</p>
        <a href="#" class="how-link" onclick="showModal('physicsModal'); return false;">How does it work?</a>
    </div>

    <form method="POST" id="analyzeForm">
        <div class="label-row">
            <label for="url">RideWithGPS URL (route, trip, or collection)</label>
            <button type="button" class="info-btn" onclick="showModal('urlModal')">?</button>
        </div>
        <div class="url-input-wrapper">
            <input type="text" id="url" name="url"
                   placeholder="https://ridewithgps.com/routes/... or .../collections/..."
                   value="{{ url or '' }}" required
                   autocomplete="off">
            <div class="url-name-overlay" id="urlNameOverlay" onclick="document.getElementById('url').focus(); event.stopPropagation();">
                <span class="route-name" id="urlNameText"></span>
                <span class="route-type" id="urlTypeText"></span>
            </div>
            <div id="recentUrlsDropdown" class="recent-urls-dropdown hidden"></div>
        </div>
        <input type="hidden" id="mode" name="mode" value="route">

        <div class="compare-toggle">
            <label>
                <input type="checkbox" id="compareCheckbox" {{ 'checked' if compare_mode else '' }} onchange="toggleCompareMode()">
                Compare this
            </label>
            <input type="hidden" id="compareMode" name="compare" value="{{ 'on' if compare_mode else '' }}">
        </div>
        <div id="compareUrlWrapper" class="{{ '' if compare_mode else 'hidden' }}">
            <div class="label-row">
                <label for="url2" class="compare-label">Compare URL (route or trip)</label>
                <button type="button" class="info-btn" onclick="showModal('urlModal')">?</button>
            </div>
            <div class="url-input-wrapper">
                <input type="text" id="url2" name="url2"
                       placeholder="https://ridewithgps.com/routes/... or .../trips/..."
                       value="{{ url2 or '' }}"
                       autocomplete="off">
                <div class="url-name-overlay" id="url2NameOverlay" onclick="document.getElementById('url2').focus(); event.stopPropagation();">
                    <span class="route-name" id="url2NameText"></span>
                    <span class="route-type" id="url2TypeText"></span>
                </div>
                <div id="recentUrlsDropdown2" class="recent-urls-dropdown hidden"></div>
            </div>
        </div>

        <div class="param-row">
            <div>
                <div class="label-row">
                    <label for="climbing_power">Climbing Power (W)</label>
                    <button type="button" class="info-btn" onclick="showModal('powerModal')">?</button>
                </div>
                <input type="number" id="climbing_power" name="climbing_power" value="{{ climbing_power }}" step="1">
            </div>
            <div>
                <div class="label-row">
                    <label for="flat_power">Flat Power (W)</label>
                    <button type="button" class="info-btn" onclick="showModal('flatPowerModal')">?</button>
                </div>
                <input type="number" id="flat_power" name="flat_power" value="{{ flat_power }}" step="1">
            </div>
            <div>
                <div class="label-row">
                    <label for="mass">Mass (kg)</label>
                    <button type="button" class="info-btn" onclick="showModal('massModal')">?</button>
                </div>
                <input type="number" id="mass" name="mass" value="{{ mass }}" step="0.1">
            </div>
            <div>
                <div class="label-row">
                    <label for="headwind">Headwind (km/h)</label>
                    <button type="button" class="info-btn" onclick="showModal('headwindModal')">?</button>
                </div>
                <input type="number" id="headwind" name="headwind" value="{{ headwind }}" step="0.1">
            </div>
        </div>

        <div class="units-row" id="unitsRow">
            <label class="toggle-label">
                <input type="checkbox" id="imperial" name="imperial" {{ 'checked' if imperial else '' }}>
                <span>Imperial units (mi, ft)</span>
            </label>
        </div>

        <div class="advanced-row">
            <div class="advanced-toggle" id="advancedToggle" onclick="toggleAdvanced()">
                <span class="chevron">▶</span>
                <span>Advanced Options</span>
            </div>
            <span class="custom-settings" title="Advanced physics model settings">
                <span class="setting" id="summaryDescPwr"><span class="setting-label">Desc Pwr:</span> <span class="setting-value">{{ descending_power|int }}W</span></span>
                <span class="setting" id="summaryBraking"><span class="setting-label">Braking:</span> <span class="setting-value">{{ "%.2f"|format(descent_braking_factor) }}</span></span>
                <span class="setting" id="summaryGravelGrade"><span class="setting-label">Gravel:</span> <span class="setting-value">Grade {{ gravel_grade }}</span></span>
                <span class="setting" id="summarySmoothing"><span class="setting-label">Smoothing:</span> <span class="setting-value">{% if result and result.effective_smoothing %}{{ result.effective_smoothing|int }}{% else %}{{ smoothing|int }}{% endif %}m</span></span>
            </span>
        </div>

        <div class="advanced-options" id="advancedOptions">
            <div class="param-row">
                <div>
                    <div class="label-row">
                        <label for="descending_power">Descent Power (W)</label>
                        <button type="button" class="info-btn" onclick="showModal('descentPowerModal')">?</button>
                    </div>
                    <input type="number" id="descending_power" name="descending_power" value="{{ descending_power }}" step="1">
                </div>
                <div>
                    <div class="label-row">
                        <label for="descent_braking_factor">Descent Braking Factor</label>
                        <button type="button" class="info-btn" onclick="showModal('descentBrakingModal')">?</button>
                    </div>
                    <input type="number" id="descent_braking_factor" name="descent_braking_factor" value="{{ descent_braking_factor }}" step="0.01" min="0.2" max="1.5">
                </div>
                <div>
                    <div class="label-row">
                        <label for="gravel_grade">Gravel Grade</label>
                        <button type="button" class="info-btn" onclick="showModal('gravelGradeModal')">?</button>
                    </div>
                    <select id="gravel_grade" name="gravel_grade">
                        <option value="1" {% if gravel_grade == 1 %}selected{% endif %}>Grade 1 - Smooth</option>
                        <option value="2" {% if gravel_grade == 2 %}selected{% endif %}>Grade 2 - Moderate</option>
                        <option value="3" {% if gravel_grade == 3 %}selected{% endif %}>Grade 3 - Chunky</option>
                        <option value="4" {% if gravel_grade == 4 %}selected{% endif %}>Grade 4 - Severe</option>
                    </select>
                </div>
                <div>
                    <div class="label-row">
                        <label for="smoothing">Smoothing Radius (m)</label>
                        <button type="button" class="info-btn" onclick="showModal('smoothingModal')">?</button>
                    </div>
                    <div class="input-with-tooltip">
                        <input type="number" id="smoothing" name="smoothing" value="{% if result and result.effective_smoothing %}{{ result.effective_smoothing|int }}{% else %}{{ smoothing|int }}{% endif %}" step="10" min="{% if result and result.noise_ratio and result.noise_ratio > 1.8 %}300{% else %}10{% endif %}" max="400">
                        {% if result and result.noise_ratio and result.noise_ratio > 1.8 %}
                        <button type="button" class="noise-warning-btn" onclick="showModal('noiseWarningModal')">⚠</button>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="advanced-reset">
                <button type="button" class="reset-btn" onclick="resetAdvancedOptions()">Reset to defaults</button>
            </div>
        </div>

        <button type="submit" id="submitBtn">Analyze</button>
    </form>

    <div id="progressContainer" class="progress-container hidden">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">Analyzing routes...</div>
        <div class="progress-route" id="progressRoute"></div>
    </div>

    <div id="errorContainer" class="error hidden"></div>

    <div id="collectionResults" class="results hidden">
        <input type="hidden" id="collectionShareUrl" value="">
        <div class="results-header">
            <h2 id="collectionName">Collection Analysis</h2>
            <button type="button" class="share-btn" onclick="copyShareLink('collectionShareUrl', this)" title="Copy link to share">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>
                <span>Share</span>
            </button>
        </div>
        <div class="result-row">
            <span class="result-label">Routes</span>
            <span class="result-value" id="totalRoutes">-</span>
        </div>
        <div class="result-row">
            <span class="result-label">Total Distance</span>
            <span class="result-value" id="totalDistance">-</span>
        </div>
        <div class="result-row">
            <span class="result-label">Total Elevation</span>
            <span class="result-value" id="totalElevation">-</span>
        </div>
        <div class="result-row">
            <span class="result-label">Total Time</span>
            <span class="result-value" id="totalTime">-</span>
        </div>
        <div class="result-row">
            <span class="result-label">Total Work</span>
            <span class="result-value" id="totalWork">-</span>
        </div>
        <div class="result-row">
            <span class="result-label">Total Energy</span>
            <span class="result-value" id="totalEnergy">-</span>
        </div>
        <div class="compare-action-bar" id="compareActionBar">
            <span class="compare-selection-info"><span id="compareSelectionCount">0</span> routes selected</span>
            <a href="#" class="compare-btn" id="compareLink">Compare</a>
        </div>
        <table class="collection-table">
            <thead>
                <tr>
                    <th class="cmp-col"><span title="Select routes to compare">Cmp</span></th>
                    <th class="sortable" data-sort="name" onclick="sortTable('name')">Route<span class="sort-indicator"></span></th>
                    <th class="num primary sortable" data-sort="time_seconds" onclick="sortTable('time_seconds')"><span class="th-with-info">Time <button type="button" class="info-btn" onclick="event.stopPropagation(); showModal('timeModal')">?</button></span><span class="sort-indicator"></span></th>
                    <th class="num primary sortable" data-sort="work_kj" onclick="sortTable('work_kj')"><span class="th-with-info">Work <button type="button" class="info-btn" onclick="event.stopPropagation(); showModal('workModal')">?</button></span><span class="sort-indicator"></span></th>
                    <th class="num primary separator sortable" data-sort="energy" onclick="sortTable('energy')"><span class="th-with-info">Energy <button type="button" class="info-btn" onclick="event.stopPropagation(); showModal('energyModal')">?</button></span><span class="sort-indicator"></span></th>
                    <th class="num sortable" data-sort="distance_km" onclick="sortTable('distance_km')">Dist<span class="sort-indicator"></span></th>
                    <th class="num sortable" data-sort="elevation_m" onclick="sortTable('elevation_m')">Elev<span class="sort-indicator"></span></th>
                    <th class="num sortable" data-sort="hilliness_score" onclick="sortTable('hilliness_score')"><span class="th-with-info">Hilly <button type="button" class="info-btn" onclick="event.stopPropagation(); showModal('hillyModal')">?</button></span><span class="sort-indicator"></span></th>
                    <th class="num sortable" data-sort="steep_time_seconds" onclick="sortTable('steep_time_seconds')"><span class="th-with-info">&gt;10% <button type="button" class="info-btn" onclick="event.stopPropagation(); showModal('steepTimeModal')">?</button></span><span class="sort-indicator"></span></th>
                    <th class="num sortable" data-sort="steepness_score" onclick="sortTable('steepness_score')"><span class="th-with-info">Steep <button type="button" class="info-btn" onclick="event.stopPropagation(); showModal('steepModal')">?</button></span><span class="sort-indicator"></span></th>
                    <th class="num sortable" data-sort="avg_speed_kmh" onclick="sortTable('avg_speed_kmh')">Speed<span class="sort-indicator"></span></th>
                    <th class="num sortable" data-sort="unpaved_pct" onclick="sortTable('unpaved_pct')">Unpvd<span class="sort-indicator"></span></th>
                    <th class="num sortable" data-sort="elevation_scale" onclick="sortTable('elevation_scale')"><span class="th-with-info">EScl <button type="button" class="info-btn" onclick="event.stopPropagation(); showModal('esclModal')">?</button></span><span class="sort-indicator"></span></th>
                </tr>
            </thead>
            <tbody id="routesTableBody">
            </tbody>
        </table>
    </div>

    <!-- Info Modals -->
    <div id="urlModal" class="modal-overlay" onclick="hideModal('urlModal')">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>RideWithGPS URL</h3>
            <p>Paste the URL of a route or collection from <a href="https://ridewithgps.com" target="_blank">ridewithgps.com</a>.</p>
            <p><strong>Route URL format:</strong><br>
            <code>https://ridewithgps.com/routes/12345678</code></p>
            <p><strong>Collection URL format:</strong><br>
            <code>https://ridewithgps.com/collections/12345</code></p>
            <p>The route must be public, or you must be logged into RideWithGPS with access to private routes.</p>
            <button class="modal-close" onclick="hideModal('urlModal')">Got it</button>
        </div>
    </div>

    <div id="powerModal" class="modal-overlay" onclick="hideModal('powerModal')">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>Climbing Power</h3>
            <p>Your sustained power output on steep climbs (grades above ~7%). Riders typically push harder uphill. For reference:</p>
            <p>• Casual climbing: 80-120W<br>• Moderate effort: 120-180W<br>• Strong rider: 180-250W</p>
            <p>For grades between 0% and 7%, power is interpolated between flat power and climbing power. Full climbing power is used only on steeper grades.</p>
            <button class="modal-close" onclick="hideModal('powerModal')">Got it</button>
        </div>
    </div>

    <div id="massModal" class="modal-overlay" onclick="hideModal('massModal')">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>Total Mass</h3>
            <p>Combined weight of rider, bike, gear, and any cargo in kilograms. This significantly affects climbing speed and energy requirements.</p>
            <p>• Rider weight + bike (~8-12kg) + gear/bags</p>
            <button class="modal-close" onclick="hideModal('massModal')">Got it</button>
        </div>
    </div>

    <div id="headwindModal" class="modal-overlay" onclick="hideModal('headwindModal')">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>Headwind</h3>
            <p>Average wind speed you expect to ride against, in km/h. Use negative values for tailwind.</p>
            <p>• Headwind (into wind): positive values<br>• Tailwind (wind behind): negative values<br>• No wind: 0</p>
            <p>Even a modest 10-15 km/h headwind significantly increases effort on flat terrain.</p>
            <button class="modal-close" onclick="hideModal('headwindModal')">Got it</button>
        </div>
    </div>

    <div id="physicsModal" class="modal-overlay" onclick="hideModal('physicsModal')">
        <div class="modal modal-large" onclick="event.stopPropagation()">
            <h3>Physics Model</h3>
            <p>Speed is calculated by solving the power balance equation: your power output equals the sum of resistive forces times velocity. All parameters below are tunable and have been calibrated against a training set of planned routes compared with actual ride data.</p>

            <h4>Primary Parameters (Biggest Impact)</h4>
            <ul class="param-list">
                <li><span class="param-name">Climbing Power (W)</span> — Power output on steep climbs. Most important input for hilly routes.</li>
                <li><span class="param-name">Flat Power (W)</span> — Power output on flat terrain. Power ramps linearly from flat to climbing power as grade increases.</li>
                <li><span class="param-name">Mass (kg)</span> — Total weight of rider + bike + gear. Dominates climbing speed since you're lifting this weight against gravity.</li>
                <li><span class="param-name">CdA (m²)</span> — Aerodynamic drag coefficient × frontal area. Controls air resistance, which grows with the cube of speed. Typical values: 0.25 (racing tuck) to 0.45 (upright touring).</li>
                <li><span class="param-name">Crr</span> — Rolling resistance coefficient. Energy lost to tire deformation and surface friction. Road tires ~0.004, gravel ~0.008-0.012.</li>
            </ul>

            <h4>Environmental Factors</h4>
            <ul class="param-list">
                <li><span class="param-name">Headwind (km/h)</span> — Wind adds to or subtracts from your effective air speed. A 15 km/h headwind at 25 km/h means you experience drag as if riding 40 km/h.</li>
                <li><span class="param-name">Air density (kg/m³)</span> — Affects aerodynamic drag. Lower at altitude (1.225 at sea level, ~1.0 at 2000m).</li>
            </ul>

            <h4>Descent Model</h4>
            <p style="margin-bottom: 0.5em; font-size: 0.9em;">Descent speed is limited by gradient steepness AND road curvature (the more restrictive wins).</p>
            <p style="margin: 0.5em 0; font-size: 0.85em;"><strong>Gradient-based:</strong></p>
            <ul class="param-list">
                <li><span class="param-name">Max coasting speed</span> — Speed limit when coasting downhill on paved roads.</li>
                <li><span class="param-name">Max coasting speed unpaved</span> — Lower speed limit for gravel/dirt descents.</li>
                <li><span class="param-name">Steep descent speed</span> — Even slower limit for very steep descents.</li>
                <li><span class="param-name">Steep descent grade</span> — Grade threshold where steep descent speed applies.</li>
                <li><span class="param-name">Coasting grade threshold</span> — Grade where you stop pedaling entirely and coast.</li>
                <li><span class="param-name">Descent braking factor</span> — Multiplier for descent speeds (1.0 = full physics speed, 0.5 = cautious braking).</li>
                <li><span class="param-name">Descent power</span> — Light pedaling power on gentle descents (drops to zero on steep grades).</li>
            </ul>
            <p style="margin: 0.5em 0; font-size: 0.85em;"><strong>Curvature-based:</strong></p>
            <ul class="param-list">
                <li><span class="param-name">Straight descent speed</span> — Max speed on straight sections (low curvature).</li>
                <li><span class="param-name">Hairpin speed</span> — Max speed through tight switchbacks (high curvature).</li>
            </ul>

            <h4>Gravel/Unpaved Model</h4>
            <ul class="param-list">
                <li><span class="param-name">Surface Crr deltas</span> — Per-surface-type rolling resistance increases based on RideWithGPS surface data. Rougher surfaces get higher Crr.</li>
                <li><span class="param-name">Gravel power factor</span> — Multiplier on power for unpaved surfaces (default 0.90 = 10% reduction). Models traction limits, vibration fatigue, and seated climbing on rough terrain.</li>
                <li><span class="param-name">Max coasting speed unpaved</span> — Lower descent speed limit on gravel/dirt roads.</li>
            </ul>
            <p style="margin: 0.3em 0; font-size: 0.85em;">Gravel sections are shown as brown strips on the elevation profile when "Show gravel" is toggled.</p>

            <h4>Data Processing</h4>
            <ul class="param-list">
                <li><span class="param-name">Smoothing radius (m)</span> — Gaussian smoothing applied to elevation data. Reduces GPS noise and unrealistic grade spikes while preserving overall climb profile.</li>
                <li><span class="param-name">Elevation scale</span> — Multiplier applied after smoothing. Auto-calculated from RideWithGPS API (DEM-corrected) elevation when available.</li>
                <li><span class="param-name">Anomaly detection</span> — Automatic detection of elevation anomalies: (1) spikes from DEM artifacts like tunnels or bridges where elevation shows the surface above rather than the actual path, and (2) dropouts from GPS/sensor errors where elevation briefly drops to zero or unrealistic values. Both are corrected by linear interpolation and highlighted with yellow bands in the elevation profile.</li>
            </ul>

            <button class="modal-close" onclick="hideModal('physicsModal')">Got it</button>
        </div>
    </div>

    <div id="flatPowerModal" class="modal-overlay" onclick="hideModal('flatPowerModal')">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>Flat Power</h3>
            <p>Your sustained power output on flat terrain. For reference:</p>
            <p>• Casual riding: 60-100W<br>• Moderate effort: 100-150W<br>• Strong rider: 150-200W</p>
            <p>Power ramps linearly from this value up to climbing power as grade increases toward ~7%.</p>
            <button class="modal-close" onclick="hideModal('flatPowerModal')">Got it</button>
        </div>
    </div>

    <div id="descentPowerModal" class="modal-overlay" onclick="hideModal('descentPowerModal')">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>Descent Power</h3>
            <p>Power output when descending (grade steeper than -2%). Models light pedaling on gentle descents.</p>
            <p><strong>0 W</strong> = pure coasting (no pedaling)<br>
            <strong>20 W</strong> = light pedaling (typical)<br>
            <strong>50+ W</strong> = active pedaling on descents</p>
            <p>On steep descents (beyond coasting threshold), power drops to zero regardless of this setting.</p>
            <button class="modal-close" onclick="hideModal('descentPowerModal')">Got it</button>
        </div>
    </div>

    <div id="descentBrakingModal" class="modal-overlay" onclick="hideModal('descentBrakingModal')">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>Descent Braking Factor</h3>
            <p>Multiplier for descent speeds. Models how cautiously you brake on descents relative to pure physics.</p>
            <p><strong>1.0</strong> = physics-based speed (aggressive)<br>
            <strong>0.5</strong> = 50% of physics speed (typical/cautious)<br>
            <strong>0.3</strong> = very cautious braking</p>
            <p>Lower values model riders who brake more on descents due to comfort, experience, or road conditions.</p>
            <button class="modal-close" onclick="hideModal('descentBrakingModal')">Got it</button>
        </div>
    </div>

    <div id="gravelGradeModal" class="modal-overlay" onclick="hideModal('gravelGradeModal')">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>Gravel Grade</h3>
            <p>Surface quality grade based on the Industry Standard Guide to Gravel (ISGG). Higher grades increase both estimated time and energy.</p>
            <p><strong>Grade 1 - Smooth:</strong> Well-maintained dirt roads, minimal loose stone. Nearly road-like.</p>
            <p><strong>Grade 2 - Moderate:</strong> Some potholes and washboard, loose corners. Typical maintained gravel.</p>
            <p><strong>Grade 3 - Chunky:</strong> Poorly maintained, exposed rocks, ruts, sand. Requires wider tires.</p>
            <p><strong>Grade 4 - Severe:</strong> Unmaintained tracks, rock gardens, deep ruts. Technical terrain.</p>
            <button class="modal-close" onclick="hideModal('gravelGradeModal')">Got it</button>
        </div>
    </div>

    <div id="smoothingModal" class="modal-overlay" onclick="hideModal('smoothingModal')">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>Smoothing Radius</h3>
            <p>Window size (in meters) for elevation smoothing. Reduces GPS noise in elevation data before calculating grades.</p>
            <p><strong>50-100m</strong> = moderate smoothing for typical routes<br>
            <strong>200m+</strong> = aggressive smoothing for very noisy data</p>
            <p>Higher values reduce noise but may underestimate short steep sections.</p>
            <button class="modal-close" onclick="hideModal('smoothingModal')">Got it</button>
        </div>
    </div>

    <div id="noiseWarningModal" class="modal-overlay" onclick="hideModal('noiseWarningModal')">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>⚠ High Elevation Noise Detected</h3>
            <p>This route has noisy GPS elevation data. The <strong>elevation noise ratio</strong> ({{ "%.1f"|format(result.noise_ratio) if result and result.noise_ratio else "?" }}×) measures raw GPS elevation gain divided by the DEM-corrected gain from RideWithGPS.</p>
            <p>A ratio above 1.8× indicates the GPS recorded significantly more elevation change than the satellite-derived terrain model, typically due to GPS signal errors or poor reception.</p>
            <p><strong>Automatic adjustment:</strong> Smoothing radius is set to 300m minimum to filter this noise. You can increase it further, but not below 300m for this route.</p>
            <button class="modal-close" onclick="hideModal('noiseWarningModal')">Got it</button>
        </div>
    </div>

    <div id="esclModal" class="modal-overlay" onclick="hideModal('esclModal')">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>Elevation Scale (EScl)</h3>
            <p>A correction factor applied to the route's elevation data. GPS elevation is often inaccurate, so this scales it to match RideWithGPS's corrected elevation from their API.</p>
            <p><strong>1.00</strong> = no correction needed<br>
            <strong>&gt;1.00</strong> = route elevation was understated<br>
            <strong>&lt;1.00</strong> = route elevation was overstated</p>
            <p>Values far from 1.0 may indicate poor GPS data quality for that route.</p>
            <button class="modal-close" onclick="hideModal('esclModal')">Got it</button>
        </div>
    </div>

    <div id="timeModal" class="modal-overlay" onclick="hideModal('timeModal')">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>Est. Moving Time</h3>
            <p>Moving time estimate based on your power output and the route's terrain. This is the time you'd spend actually riding, excluding stops.</p>
            <p>The estimate accounts for:</p>
            <p>• Slower speeds on climbs (more power needed to fight gravity)<br>
            • Faster speeds on descents (limited by safety/comfort)<br>
            • Surface type (gravel/dirt is slower than pavement)</p>
            <button class="modal-close" onclick="hideModal('timeModal')">Got it</button>
        </div>
    </div>

    <div id="workModal" class="modal-overlay" onclick="hideModal('workModal')">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>Est. Work</h3>
            <p>Total mechanical energy expenditure in kilojoules (kJ). This is the energy your legs put into the pedals.</p>
            <p>Useful for estimating food/fuel needs:</p>
            <p>• Human efficiency is ~20-25%, so multiply by 4-5 for calories burned<br>
            • Example: 1000 kJ of work ≈ 4000-5000 kJ (950-1200 kcal) of food energy</p>
            <button class="modal-close" onclick="hideModal('workModal')">Got it</button>
        </div>
    </div>

    <div id="energyModal" class="modal-overlay" onclick="hideModal('energyModal')">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>Est. Energy</h3>
            <p>Estimated food energy needed to fuel this ride, accounting for ~22% human efficiency.</p>
            <p><strong>Unit equivalents:</strong></p>
            <p>• 1 medium banana ≈ 100 kcal<br>
            • 1 baguette (250g) ≈ 680 kcal</p>
            <button class="modal-close" onclick="hideModal('energyModal')">Got it</button>
        </div>
    </div>

    <div id="hillyModal" class="modal-overlay" onclick="hideModal('hillyModal')">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>Hilliness</h3>
            <p>Total elevation gain per unit distance (m/km or ft/mi). Measures <em>how much</em> climbing a route has, normalized by length.</p>
            <p>Typical values:</p>
            <p>• Flat: 0-5 m/km (0-26 ft/mi)<br>
            • Rolling: 5-15 m/km (26-79 ft/mi)<br>
            • Hilly: 15-25 m/km (79-132 ft/mi)<br>
            • Mountainous: 25+ m/km (132+ ft/mi)</p>
            <button class="modal-close" onclick="hideModal('hillyModal')">Got it</button>
        </div>
    </div>

    <div id="steepModal" class="modal-overlay" onclick="hideModal('steepModal')">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>Steepness</h3>
            <p>Effort-weighted average grade of climbs 2% and steeper. Measures <em>how steep</em> the climbs are, not just how much climbing.</p>
            <p>Steeper sections count more because they require disproportionately more power. A route with punchy 10% grades will score higher than one with gentle 4% grades, even if total climbing is similar.</p>
            <p>Typical values:</p>
            <p>• Gentle climbs: 3-5%<br>
            • Moderate climbs: 5-7%<br>
            • Steep climbs: 7-10%<br>
            • Very steep: 10%+</p>
            <button class="modal-close" onclick="hideModal('steepModal')">Got it</button>
        </div>
    </div>

    <div id="steepTimeModal" class="modal-overlay" onclick="hideModal('steepTimeModal')">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>Time at &gt;10% Grade</h3>
            <p>Total time spent climbing at grades steeper than 10%, based on the physics simulation using your input parameters (power, mass, etc.).</p>
            <p>This measures how long you'll be grinding up very steep sections. Even short steep pitches add up and can significantly affect overall effort and pacing.</p>
            <button class="modal-close" onclick="hideModal('steepTimeModal')">Got it</button>
        </div>
    </div>

    <div id="brakingModal" class="modal-overlay" onclick="hideModal('brakingModal')">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>Braking Factor</h3>
            <p>The braking factor measures how fast you descend compared to the theoretical maximum coasting speed (48 km/h).</p>
            <p>• <strong>&lt; 1.0</strong> - More cautious descending (braking)<br>
            • <strong>= 1.0</strong> - Descending at expected speed<br>
            • <strong>&gt; 1.0</strong> - Faster descending (tucking, drafting)</p>
            <p>This is calculated from your actual descent speeds on segments with grade &lt; -2%.</p>
            <button class="modal-close" onclick="hideModal('brakingModal')">Got it</button>
        </div>
    </div>

    <div id="powerClimbingModal" class="modal-overlay" onclick="hideModal('powerClimbingModal')">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>Power (Climbing)</h3>
            <p>Your average power output on climbing segments, where the grade is steeper than +2%.</p>
            <p>This reflects the effort required to overcome gravity on uphills. Climbing power is typically 10-30% higher than flat power for most riders.</p>
            <button class="modal-close" onclick="hideModal('powerClimbingModal')">Got it</button>
        </div>
    </div>

    <div id="powerFlatModal" class="modal-overlay" onclick="hideModal('powerFlatModal')">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>Power (Flat)</h3>
            <p>Your average power output on flat segments, where the grade is between -2% and +2%.</p>
            <p>On flat terrain, most of your power goes to overcoming air resistance. This is typically your sustainable cruising power.</p>
            <button class="modal-close" onclick="hideModal('powerFlatModal')">Got it</button>
        </div>
    </div>

    <div id="powerDescendingModal" class="modal-overlay" onclick="hideModal('powerDescendingModal')">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>Power (Descending)</h3>
            <p>Your average power output on descending segments, where the grade is steeper than -2%.</p>
            <p>On descents, gravity assists you so less pedaling is needed. This value is typically low or near zero if you're coasting.</p>
            <button class="modal-close" onclick="hideModal('powerDescendingModal')">Got it</button>
        </div>
    </div>

    <div id="steepClimbsModal" class="modal-overlay" onclick="hideModal('steepClimbsModal')">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>Steep Climbs Methodology</h3>
            <p><strong>Max Grade</strong> is calculated using a 150m rolling average to filter GPS noise. This gives the maximum <em>sustained</em> grade over a meaningful distance.</p>
            <p><strong>Grade Histogram</strong> uses the same 150m rolling average, so grades shown will never exceed the max grade. This ensures consistency between the reported maximum and the histogram distribution.</p>
            <p><strong>Smoothing</strong> Elevation data is smoothed with a Gaussian filter before grade calculation to reduce GPS noise. Point-to-point GPS measurements can show unrealistic spikes (50%+ grades) due to elevation errors. Smoothing filters these artifacts while still capturing steep sections that riders actually experience.</p>
            <button class="modal-close" onclick="hideModal('steepClimbsModal')">Got it</button>
        </div>
    </div>

    <div id="noiseModal" class="modal-overlay" onclick="hideModal('noiseModal')">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>Elevation Noise Ratio</h3>
            <p>The <strong>noise ratio</strong> compares raw GPS elevation gain to the DEM (Digital Elevation Model) elevation gain from RideWithGPS.</p>
            <p><strong>What it means:</strong></p>
            <p>• <strong>1.0x</strong>: GPS and DEM match perfectly (rare)<br>
            • <strong>1.0-1.5x</strong>: Normal GPS noise<br>
            • <strong>1.5-1.8x</strong>: Elevated noise (tree cover, canyons)<br>
            • <strong>&gt;1.8x</strong>: High noise - smoothing auto-increased to 300m</p>
            <p><strong>Why this matters:</strong> Noisy GPS elevation creates artificial ups and downs that inflate grade calculations. Higher smoothing reduces this noise but may slightly soften real grade changes.</p>
            <p><strong>Auto-adjustment:</strong> When noise exceeds 1.8x, smoothing is automatically increased to 300m minimum. You can set a higher value in advanced options if needed.</p>
            <button class="modal-close" onclick="hideModal('noiseModal')">Got it</button>
        </div>
    </div>

    <script>
        // Recent URLs management
        var MAX_RECENT_URLS = 20;

        function getRecentUrls() {
            try {
                var data = JSON.parse(localStorage.getItem('recentUrls') || '[]');
                // Handle migration from old format (array of strings) to new format (array of objects)
                if (data.length > 0 && typeof data[0] === 'string') {
                    data = data.map(function(url) { return {url: url, name: null}; });
                    localStorage.setItem('recentUrls', JSON.stringify(data));
                }
                return data;
            } catch (e) {
                return [];
            }
        }

        function saveRecentUrl(url, name) {
            if (!url || !url.includes('ridewithgps.com')) return;
            var urls = getRecentUrls();
            // Remove if already exists (will re-add at top)
            urls = urls.filter(function(u) { return u.url !== url; });
            // Add to front
            urls.unshift({url: url, name: name || null});
            // Keep only last N
            urls = urls.slice(0, MAX_RECENT_URLS);
            localStorage.setItem('recentUrls', JSON.stringify(urls));
            populateRecentUrls();
            // Update name overlays (delayed to avoid interfering with current focus)
            setTimeout(function() {
                updateUrlNameOverlay('url', 'urlNameOverlay', 'urlNameText', 'urlTypeText');
                updateUrlNameOverlay('url2', 'url2NameOverlay', 'url2NameText', 'url2TypeText');
            }, 100);
        }

        function getNameForUrl(url) {
            if (!url) return null;
            var urls = getRecentUrls();
            for (var i = 0; i < urls.length; i++) {
                if (urls[i].url === url) {
                    return urls[i].name;
                }
            }
            return null;
        }

        function getUrlType(url) {
            if (!url) return '';
            if (url.includes('/collections/')) return 'collection';
            if (url.includes('/trips/')) return 'trip';
            if (url.includes('/routes/')) return 'route';
            return '';
        }

        function updateUrlNameOverlay(inputId, overlayId, textId, typeId) {
            var input = document.getElementById(inputId);
            var overlay = document.getElementById(overlayId);
            var text = document.getElementById(textId);
            var typeEl = document.getElementById(typeId);
            if (!input || !overlay || !text) return;

            var url = input.value.trim();
            var name = getNameForUrl(url);
            var type = getUrlType(url);

            // Only show overlay if input is not focused and we have a name
            if (name && document.activeElement !== input) {
                text.textContent = name;
                if (typeEl) typeEl.textContent = type ? '(' + type + ')' : '';
                overlay.classList.add('visible');
            } else {
                overlay.classList.remove('visible');
            }
        }

        function hideUrlNameOverlay(overlayId) {
            var overlay = document.getElementById(overlayId);
            if (overlay) overlay.classList.remove('visible');
        }

        function showUrlNameOverlay(inputId, overlayId, textId, typeId, dropdownId) {
            // Small delay to let dropdown click complete
            setTimeout(function() {
                // Don't show overlay if dropdown is still visible (user might be clicking it)
                var dropdown = document.getElementById(dropdownId);
                if (dropdown && !dropdown.classList.contains('hidden')) {
                    return;
                }
                updateUrlNameOverlay(inputId, overlayId, textId, typeId);
            }, 200);
        }

        function populateRecentUrls(dropdownId, inputId, excludeCurrentUrl) {
            var dropdown = document.getElementById(dropdownId);
            if (!dropdown) return;  // Guard against missing element
            var urls = getRecentUrls();
            // For compare dropdown, exclude the URL already in the primary input
            if (excludeCurrentUrl) {
                var primaryUrl = document.getElementById('url').value;
                if (primaryUrl) {
                    urls = urls.filter(function(item) { return item.url !== primaryUrl; });
                }
            }
            if (urls.length === 0) {
                dropdown.innerHTML = '';
                return;
            }
            var html = '<div class="recent-urls-header">Recent</div>';
            urls.forEach(function(item) {
                var urlPreview = item.url.replace('https://ridewithgps.com/', '');
                if (item.name) {
                    html += '<div class="recent-url-item" data-url="' + item.url + '">' +
                            '<div class="recent-url-name">' + item.name + '</div>' +
                            '<div class="recent-url-path">' + urlPreview + '</div>' +
                            '</div>';
                } else {
                    html += '<div class="recent-url-item" data-url="' + item.url + '">' +
                            '<div class="recent-url-path">' + urlPreview + '</div>' +
                            '</div>';
                }
            });
            dropdown.innerHTML = html;

            // Add click handlers
            dropdown.querySelectorAll('.recent-url-item').forEach(function(item) {
                item.addEventListener('click', function() {
                    document.getElementById(inputId).value = this.getAttribute('data-url');
                    dropdown.classList.add('hidden');
                    if (inputId === 'url') {
                        updateModeIndicator();
                        updateUrlNameOverlay('url', 'urlNameOverlay', 'urlNameText', 'urlTypeText');
                    } else if (inputId === 'url2') {
                        updateUrlNameOverlay('url2', 'url2NameOverlay', 'url2NameText', 'url2TypeText');
                    }
                });
            });
        }

        function setupUrlDropdown() {
            // Setup primary URL input
            var urlInput = document.getElementById('url');
            var dropdown = document.getElementById('recentUrlsDropdown');

            urlInput.addEventListener('focus', function() {
                hideUrlNameOverlay('urlNameOverlay');
                if (getRecentUrls().length > 0) {
                    populateRecentUrls('recentUrlsDropdown', 'url', false);
                    dropdown.classList.remove('hidden');
                }
            });

            urlInput.addEventListener('input', updateModeIndicator);

            // Show name overlay on blur (after paste or manual entry)
            urlInput.addEventListener('blur', function() {
                showUrlNameOverlay('url', 'urlNameOverlay', 'urlNameText', 'urlTypeText', 'recentUrlsDropdown');
            });

            // Setup secondary URL input (compare mode)
            var url2Input = document.getElementById('url2');
            var dropdown2 = document.getElementById('recentUrlsDropdown2');

            url2Input.addEventListener('focus', function() {
                hideUrlNameOverlay('url2NameOverlay');
                var urls = getRecentUrls().filter(function(item) { return item.url.includes('/routes/'); });
                if (urls.length > 0) {
                    populateRecentUrls('recentUrlsDropdown2', 'url2', true);
                    dropdown2.classList.remove('hidden');
                }
            });

            // Show name overlay on blur for url2
            url2Input.addEventListener('blur', function() {
                showUrlNameOverlay('url2', 'url2NameOverlay', 'url2NameText', 'url2TypeText', 'recentUrlsDropdown2');
            });

            // Initialize name overlays on page load
            updateUrlNameOverlay('url', 'urlNameOverlay', 'urlNameText', 'urlTypeText');
            updateUrlNameOverlay('url2', 'url2NameOverlay', 'url2NameText', 'url2TypeText');

            // Keyboard navigation helper
            function handleDropdownKeyboard(e, inputId, dropdownId) {
                var dropdown = document.getElementById(dropdownId);

                // If dropdown is hidden and ArrowDown pressed, show it
                if (dropdown.classList.contains('hidden')) {
                    if (e.key === 'ArrowDown' && getRecentUrls().length > 0) {
                        e.preventDefault();
                        var excludeCurrent = (inputId === 'url2');
                        populateRecentUrls(dropdownId, inputId, excludeCurrent);
                        dropdown.classList.remove('hidden');
                        return true;
                    }
                    return false;
                }

                var items = dropdown.querySelectorAll('.recent-url-item');
                if (items.length === 0) return false;

                // Find current highlighted index
                var currentIndex = -1;
                for (var i = 0; i < items.length; i++) {
                    if (items[i].classList.contains('highlighted')) {
                        currentIndex = i;
                        break;
                    }
                }

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    // Clear all highlights
                    items.forEach(function(item) { item.classList.remove('highlighted'); });
                    var nextIndex = (currentIndex + 1) % items.length;
                    items[nextIndex].classList.add('highlighted');
                    items[nextIndex].scrollIntoView({ block: 'nearest' });
                    return true;
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    // Clear all highlights
                    items.forEach(function(item) { item.classList.remove('highlighted'); });
                    var prevIndex = currentIndex <= 0 ? items.length - 1 : currentIndex - 1;
                    items[prevIndex].classList.add('highlighted');
                    items[prevIndex].scrollIntoView({ block: 'nearest' });
                    return true;
                } else if (e.key === 'Enter' && currentIndex >= 0) {
                    e.preventDefault();
                    items[currentIndex].click();
                    return true;
                }
                return false;
            }

            // Hide dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (!urlInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
                if (!url2Input.contains(e.target) && !dropdown2.contains(e.target)) {
                    dropdown2.classList.add('hidden');
                }
            });

            // Keyboard navigation for dropdowns
            urlInput.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    dropdown.classList.add('hidden');
                } else {
                    handleDropdownKeyboard(e, 'url', 'recentUrlsDropdown');
                }
            });
            url2Input.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    dropdown2.classList.add('hidden');
                } else {
                    handleDropdownKeyboard(e, 'url2', 'recentUrlsDropdown2');
                }
            });

            // Initialize mode indicator
            updateModeIndicator();

            // Prepopulate with example route on first visit
            if (getRecentUrls().length === 0 && !urlInput.value) {
                urlInput.value = 'https://ridewithgps.com/routes/48889111';
                updateModeIndicator();
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            setupUrlDropdown();
            initAdvancedOptions();
        });
        if (document.readyState !== 'loading') {
            setupUrlDropdown();
            initAdvancedOptions();
        }

        function showModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function hideModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function toggleAdvanced() {
            var toggle = document.getElementById('advancedToggle');
            var options = document.getElementById('advancedOptions');
            toggle.classList.toggle('expanded');
            options.classList.toggle('visible');
            // Save state to localStorage
            localStorage.setItem('advancedOptionsExpanded', options.classList.contains('visible'));
        }

        function initAdvancedOptions() {
            // Restore advanced options visibility from localStorage
            var expanded = localStorage.getItem('advancedOptionsExpanded') === 'true';
            if (expanded) {
                var toggle = document.getElementById('advancedToggle');
                var options = document.getElementById('advancedOptions');
                if (toggle && options) {
                    toggle.classList.add('expanded');
                    options.classList.add('visible');
                }
            }
            // Sync summary with actual input values
            updateAdvancedSummary();
            // Add listeners to keep summary in sync
            ['descending_power', 'descent_braking_factor', 'gravel_grade', 'smoothing'].forEach(function(id) {
                var el = document.getElementById(id);
                if (el) el.addEventListener('input', updateAdvancedSummary);
                if (el) el.addEventListener('change', updateAdvancedSummary);
            });
        }

        function resetAdvancedOptions() {
            document.getElementById('descent_braking_factor').value = {{ defaults.descent_braking_factor }};
            document.getElementById('descending_power').value = {{ defaults.descending_power|int }};
            document.getElementById('gravel_grade').value = {{ defaults.gravel_grade }};
            var smoothingInput = document.getElementById('smoothing');
            var minSmoothing = parseInt(smoothingInput.min) || 10;
            smoothingInput.value = Math.max({{ defaults.smoothing|int }}, minSmoothing);
            updateAdvancedSummary();
        }

        function updateAdvancedSummary() {
            var defaults = {
                descending_power: {{ defaults.descending_power|int }},
                descent_braking_factor: {{ defaults.descent_braking_factor }},
                gravel_grade: {{ defaults.gravel_grade }},
                smoothing: {{ defaults.smoothing|int }}
            };

            var descPwr = parseInt(document.getElementById('descending_power').value) || 0;
            var braking = parseFloat(document.getElementById('descent_braking_factor').value) || 0;
            var gravelGrade = parseInt(document.getElementById('gravel_grade').value) || 2;
            var smoothingInput = document.getElementById('smoothing');
            var smoothing = parseInt(smoothingInput.value) || 0;
            var minSmoothing = parseInt(smoothingInput.min) || 10;

            var summaryDescPwr = document.getElementById('summaryDescPwr');
            var summaryBraking = document.getElementById('summaryBraking');
            var summaryGravelGrade = document.getElementById('summaryGravelGrade');
            var summarySmoothing = document.getElementById('summarySmoothing');

            if (summaryDescPwr) {
                summaryDescPwr.querySelector('.setting-value').textContent = descPwr + 'W';
                summaryDescPwr.classList.toggle('modified', descPwr !== defaults.descending_power);
            }
            if (summaryBraking) {
                summaryBraking.querySelector('.setting-value').textContent = braking.toFixed(2);
                summaryBraking.classList.toggle('modified', Math.abs(braking - defaults.descent_braking_factor) > 0.001);
            }
            if (summaryGravelGrade) {
                summaryGravelGrade.querySelector('.setting-value').textContent = 'Grade ' + gravelGrade;
                summaryGravelGrade.classList.toggle('modified', gravelGrade !== defaults.gravel_grade);
            }
            if (summarySmoothing) {
                summarySmoothing.querySelector('.setting-value').textContent = smoothing + 'm';
                // Modified if different from default (considering auto-adjusted minimum)
                var isModified = (minSmoothing > defaults.smoothing) ? (smoothing > minSmoothing) : (smoothing !== defaults.smoothing);
                summarySmoothing.classList.toggle('modified', isModified);
            }
        }

        function _buildOverlayParams() {
            var params = '';
            var speedCheckbox = document.getElementById('overlay_speed');
            if (speedCheckbox && speedCheckbox.checked) params += '&overlay=speed';
            var gradeCheckbox = document.getElementById('overlay_grade');
            if (gradeCheckbox && gradeCheckbox.checked) params += '&overlay=grade';
            var gravelCheckbox = document.getElementById('overlay_gravel');
            if (gravelCheckbox && gravelCheckbox.checked) params += '&show_gravel=true';
            if (isImperial()) params += '&imperial=true';
            return params;
        }

        function _getEffectiveTimeHours(container, collapseCheckbox) {
            // Return the effective time (moving or elapsed) based on checkbox state
            if (collapseCheckbox && collapseCheckbox.checked) {
                return parseFloat(container.getAttribute('data-moving-time-hours') || 0);
            } else {
                return parseFloat(container.getAttribute('data-elapsed-time-hours') ||
                                  container.getAttribute('data-moving-time-hours') || 0);
            }
        }

        function _recalcMaxXlimHours() {
            // Recalculate synchronized max_xlim_hours based on current checkbox states
            var container1 = document.getElementById('elevationContainer1');
            var container2 = document.getElementById('elevationContainer2');
            if (!container1 || !container2) return null;  // Not in comparison mode

            var cb1 = document.getElementById('collapseStops1');
            var cb2 = document.getElementById('collapseStops2');
            var t1 = _getEffectiveTimeHours(container1, cb1);
            var t2 = _getEffectiveTimeHours(container2, cb2);
            return Math.max(t1, t2);
        }

        function _refreshComparisonProfiles() {
            // Refresh both profiles with synchronized max_xlim_hours
            var maxXlim = _recalcMaxXlimHours();
            if (maxXlim === null) return;  // Not in comparison mode

            ['1', '2'].forEach(function(suffix) {
                var container = document.getElementById('elevationContainer' + suffix);
                var img = document.getElementById('elevationImg' + suffix);
                var loading = document.getElementById('elevationLoading' + suffix);
                if (!container || !img) return;

                var baseProfileUrl = container.getAttribute('data-base-profile-url');
                var baseDataUrl = container.getAttribute('data-base-data-url');
                if (!baseProfileUrl) return;

                var collapseCheckbox = document.getElementById('collapseStops' + suffix);
                var collapseParam = (collapseCheckbox && collapseCheckbox.checked) ? '&collapse_stops=true' : '';
                var overlayParams = _buildOverlayParams();

                // Update stored max_xlim_hours
                container.setAttribute('data-max-xlim-hours', maxXlim.toFixed(4));

                // Show loading spinner
                if (loading) {
                    loading.classList.remove('hidden');
                    img.classList.add('loading');
                }

                // Update image source with new max_xlim_hours
                img.src = baseProfileUrl + '&max_xlim_hours=' + maxXlim.toFixed(4) + collapseParam + overlayParams;

                // Re-setup the elevation profile tooltip
                if (typeof window.setupElevationProfile === 'function' && baseDataUrl) {
                    window.setupElevationProfile(
                        'elevationContainer' + suffix,
                        'elevationImg' + suffix,
                        'elevationTooltip' + suffix,
                        'elevationCursor' + suffix,
                        baseDataUrl + collapseParam,
                        maxXlim
                    );
                }
            });
        }

        function toggleCollapseStops(profileNum) {
            // Handle both single profile (no num) and comparison mode (1 or 2)
            var suffix = profileNum ? profileNum : '';
            var checkbox = document.getElementById('collapseStops' + suffix);
            var container = document.getElementById('elevationContainer' + suffix);
            var img = document.getElementById('elevationImg' + suffix);
            var loading = document.getElementById('elevationLoading' + suffix);

            if (!checkbox || !container || !img) return;

            // Save preference to localStorage
            localStorage.setItem('collapseStops' + suffix, checkbox.checked);

            // In comparison mode, refresh both profiles with synchronized x-axis
            var container1 = document.getElementById('elevationContainer1');
            var container2 = document.getElementById('elevationContainer2');
            if (container1 && container2) {
                _refreshComparisonProfiles();
                return;
            }

            // Single profile mode - original behavior
            var baseProfileUrl = container.getAttribute('data-base-profile-url');
            var baseDataUrl = container.getAttribute('data-base-data-url');
            var maxXlimHours = container.getAttribute('data-max-xlim-hours');
            var maxXlim = maxXlimHours ? parseFloat(maxXlimHours) : null;

            if (!baseProfileUrl) return;

            var collapseParam = checkbox.checked ? '&collapse_stops=true' : '';
            var overlayParams = _buildOverlayParams();

            // Show loading spinner
            loading.classList.remove('hidden');
            img.classList.add('loading');

            // Update image source
            img.src = baseProfileUrl + collapseParam + overlayParams;

            // Re-setup the elevation profile tooltip with new data URL
            if (typeof window.setupElevationProfile === 'function' && baseDataUrl) {
                window.setupElevationProfile(
                    'elevationContainer' + suffix,
                    'elevationImg' + suffix,
                    'elevationTooltip' + suffix,
                    'elevationCursor' + suffix,
                    baseDataUrl + collapseParam,
                    maxXlim
                );
            }
        }

        function initCollapseStops(skipRefresh) {
            // Restore collapse stops preferences from localStorage
            ['', '1', '2'].forEach(function(suffix) {
                var checkbox = document.getElementById('collapseStops' + suffix);
                if (checkbox) {
                    var saved = localStorage.getItem('collapseStops' + suffix) === 'true';
                    if (saved) {
                        checkbox.checked = true;
                        if (!skipRefresh) {
                            toggleCollapseStops(suffix === '' ? null : parseInt(suffix));
                        }
                    }
                }
            });
        }

        function goToRidePage() {
            var urlInput = document.getElementById('url');
            if (!urlInput || !urlInput.value) return;
            var url = '/ride?url=' + encodeURIComponent(urlInput.value);
            url += '&climbing_power={{ climbing_power }}&flat_power={{ flat_power }}&mass={{ mass }}&headwind={{ headwind }}&smoothing={{ smoothing }}';
            if (document.getElementById('imperial')?.checked) url += '&imperial=1';
            // Save current overlay states to localStorage for ride page to read
            try {
                localStorage.setItem('ride_show_speed', document.getElementById('overlay_speed')?.checked || false);
                localStorage.setItem('ride_show_grade', document.getElementById('overlay_grade')?.checked || false);
                localStorage.setItem('ride_show_gravel', document.getElementById('overlay_gravel')?.checked || false);
                localStorage.setItem('ride_imperial', document.getElementById('imperial')?.checked || false);
            } catch (e) {}
            window.location.href = url;
        }

        function toggleOverlay(type) {
            var checkbox = document.getElementById('overlay_' + type);
            if (!checkbox) return;

            // Speed and grade are mutually exclusive (only one secondary Y-axis)
            if (checkbox.checked && (type === 'speed' || type === 'grade')) {
                var otherType = type === 'speed' ? 'grade' : 'speed';
                var otherCheckbox = document.getElementById('overlay_' + otherType);
                if (otherCheckbox && otherCheckbox.checked) {
                    otherCheckbox.checked = false;
                    localStorage.setItem('overlay_' + otherType, 'false');
                }
            }

            // Refresh all visible elevation profiles
            ['', '1', '2'].forEach(function(suffix) {
                var container = document.getElementById('elevationContainer' + suffix);
                var img = document.getElementById('elevationImg' + suffix);
                var loading = document.getElementById('elevationLoading' + suffix);
                if (!container || !img) return;

                var baseProfileUrl = container.getAttribute('data-base-profile-url');
                var baseDataUrl = container.getAttribute('data-base-data-url');
                var maxXlimHours = container.getAttribute('data-max-xlim-hours');
                var maxXlim = maxXlimHours ? parseFloat(maxXlimHours) : null;
                if (!baseProfileUrl) return;

                // Build collapse_stops param for this specific profile
                var collapseCheckbox = document.getElementById('collapseStops' + suffix);
                var collapseParam = (collapseCheckbox && collapseCheckbox.checked) ? '&collapse_stops=true' : '';
                var overlayParams = _buildOverlayParams();

                // Preserve zoom state from container data attributes
                var xlimParams = '';
                var zoomMin = container.getAttribute('data-zoom-min');
                var zoomMax = container.getAttribute('data-zoom-max');
                if (zoomMin && zoomMax) {
                    // Zoomed: use zoom bounds
                    xlimParams = '&min_xlim_hours=' + zoomMin + '&max_xlim_hours=' + zoomMax;
                } else if (maxXlim) {
                    // Not zoomed but in comparison mode: use synchronized max_xlim
                    xlimParams = '&max_xlim_hours=' + maxXlim.toFixed(4);
                }

                loading.classList.remove('hidden');
                img.classList.add('loading');
                img.src = baseProfileUrl + collapseParam + overlayParams + xlimParams;

                if (typeof window.setupElevationProfile === 'function' && baseDataUrl) {
                    window.setupElevationProfile(
                        'elevationContainer' + suffix,
                        'elevationImg' + suffix,
                        'elevationTooltip' + suffix,
                        'elevationCursor' + suffix,
                        baseDataUrl + collapseParam,
                        maxXlim
                    );
                }
            });

            localStorage.setItem('overlay_' + type, checkbox.checked);
        }

        function initOverlays(skipRefresh) {
            ['speed', 'grade', 'gravel'].forEach(function(type) {
                var checkbox = document.getElementById('overlay_' + type);
                if (checkbox) {
                    var saved = localStorage.getItem('overlay_' + type) === 'true';
                    if (saved) {
                        checkbox.checked = true;
                        if (!skipRefresh) {
                            toggleOverlay(type);
                        }
                    }
                }
            });
        }

        function toggleCompareMode() {
            var wrapper = document.getElementById('compareUrlWrapper');
            var checkbox = document.getElementById('compareCheckbox');
            var hiddenInput = document.getElementById('compareMode');

            if (checkbox.checked) {
                wrapper.classList.remove('hidden');
                hiddenInput.value = 'on';
            } else {
                wrapper.classList.add('hidden');
                hiddenInput.value = '';
            }
        }

        function copyShareLink(inputId, btn) {
            var shareUrl = document.getElementById(inputId).value;
            var originalHtml = btn.innerHTML;
            navigator.clipboard.writeText(shareUrl).then(function() {
                btn.innerHTML = '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg><span>Copied</span>';
                btn.classList.add('copied');
                setTimeout(function() {
                    btn.innerHTML = originalHtml;
                    btn.classList.remove('copied');
                }, 2000);
            }).catch(function() {
                // Fallback for older browsers
                prompt('Copy this link:', shareUrl);
            });
        }

        function detectModeFromUrl(url) {
            if (url.includes('/collections/')) {
                return 'collection';
            } else if (url.includes('/routes/')) {
                return 'route';
            }
            return null;
        }

        function updateModeIndicator() {
            var url = document.getElementById('url').value;
            var mode = detectModeFromUrl(url);
            var modeInput = document.getElementById('mode');
            var compareToggle = document.querySelector('.compare-toggle');
            var compareCheckbox = document.getElementById('compareCheckbox');

            if (mode === 'collection') {
                modeInput.value = 'collection';
                // Hide compare mode for collections
                if (compareCheckbox.checked) {
                    compareCheckbox.checked = false;
                    toggleCompareMode();
                }
                compareToggle.classList.add('hidden');
            } else {
                modeInput.value = 'route';
                compareToggle.classList.remove('hidden');
            }
        }

        function formatDuration(seconds) {
            var hours = Math.floor(seconds / 3600);
            var minutes = Math.floor((seconds % 3600) / 60);
            if (hours > 0) {
                return hours + 'h ' + String(minutes).padStart(2, '0') + 'm';
            }
            return minutes + 'm';
        }

        function hideAllResults() {
            document.getElementById('progressContainer').classList.add('hidden');
            document.getElementById('errorContainer').classList.add('hidden');
            document.getElementById('collectionResults').classList.add('hidden');
            document.body.classList.remove('collection-mode');
            // Hide server-rendered single route results
            var singleResults = document.getElementById('singleRouteResults');
            if (singleResults) singleResults.style.display = 'none';
            // Hide server-rendered errors
            var serverErrors = document.querySelectorAll('.server-error');
            serverErrors.forEach(function(el) { el.style.display = 'none'; });
        }

        function showError(message) {
            hideAllResults();
            var errorEl = document.getElementById('errorContainer');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }

        function isImperial() {
            return document.getElementById('imperial').checked;
        }

        function formatDist(km) {
            if (isImperial()) {
                return Math.round(km * 0.621371) + '<span class="u">mi</span>';
            }
            return Math.round(km) + '<span class="u">km</span>';
        }

        function formatElev(m) {
            if (isImperial()) {
                return Math.round(m * 3.28084) + '<span class="u">ft</span>';
            }
            return Math.round(m) + '<span class="u">m</span>';
        }

        function formatSpeed(kmh) {
            if (isImperial()) {
                return (kmh * 0.621371).toFixed(1) + '<span class="u">mph</span>';
            }
            return kmh.toFixed(1) + '<span class="u">km/h</span>';
        }

        function formatHilliness(mkm) {
            if (isImperial()) {
                // m/km to ft/mi: (3.28084 ft/m) / (0.621371 mi/km) ≈ 5.28
                return Math.round(mkm * 5.28) + '<span class="u">ft/mi</span>';
            }
            return Math.round(mkm) + '<span class="u">m/km</span>';
        }

        function formatSteepTime(seconds) {
            if (!seconds || seconds < 60) return '-';
            var mins = Math.round(seconds / 60);
            if (mins < 60) return mins + '<span class="u">min</span>';
            var hours = Math.floor(mins / 60);
            var remainMins = mins % 60;
            return hours + '<span class="u">h</span>' + (remainMins < 10 ? '0' : '') + remainMins + '<span class="u">m</span>';
        }

        function formatTimeStr(timeStr) {
            // Convert "2h 30m" or "45m" to have styled units
            if (!timeStr) return '-';
            return timeStr.replace(/(\d+)(h)\s*/g, '$1<span class="u">$2</span> ')
                          .replace(/(\d+)(m)$/g, '$1<span class="u">$2</span>');
        }

        function formatDistFull(km) {
            if (isImperial()) {
                return Math.round(km * 0.621371) + ' mi';
            }
            return Math.round(km) + ' km';
        }

        function formatElevFull(m) {
            if (isImperial()) {
                return Math.round(m * 3.28084) + ' ft';
            }
            return Math.round(m) + ' m';
        }

        // Collect all rider/analysis parameters for URL building
        function collectAllParams() {
            var params = new URLSearchParams();
            // Basic params
            params.set('climbing_power', document.getElementById('climbing_power').value);
            params.set('flat_power', document.getElementById('flat_power').value);
            params.set('mass', document.getElementById('mass').value);
            params.set('headwind', document.getElementById('headwind').value);
            // Advanced params
            params.set('descending_power', document.getElementById('descending_power').value);
            params.set('descent_braking_factor', document.getElementById('descent_braking_factor').value);
            params.set('gravel_grade', document.getElementById('gravel_grade').value);
            params.set('smoothing', document.getElementById('smoothing').value);
            // Imperial setting
            if (document.getElementById('imperial').checked) {
                params.set('imperial', '1');
            }
            return params;
        }

        function buildAnalyzeUrl(routeUrl) {
            var params = collectAllParams();
            params.set('url', routeUrl);
            return window.location.origin + window.location.pathname + '?' + params.toString();
        }

        function updateTotals(routes) {
            var totalDist = 0, totalElev = 0, totalTime = 0, totalWork = 0, totalSteepTime = 0;
            routes.forEach(function(r) {
                totalDist += r.distance_km;
                totalElev += r.elevation_m;
                totalTime += r.time_seconds;
                totalWork += r.work_kj;
                totalSteepTime += r.steep_time_seconds || 0;
            });
            document.getElementById('totalRoutes').textContent = routes.length;
            document.getElementById('totalDistance').textContent = formatDistFull(totalDist);
            document.getElementById('totalElevation').textContent = formatElevFull(totalElev);
            document.getElementById('totalTime').textContent = formatDuration(totalTime);
            document.getElementById('totalWork').textContent = Math.round(totalWork) + ' kJ';
            document.getElementById('totalEnergy').textContent = Math.round(totalWork * 1.075) + ' kcal';

            // Update totals row
            var tbody = document.getElementById('routesTableBody');
            var existingTotals = tbody.querySelector('.totals-row');
            if (existingTotals) {
                existingTotals.remove();
            }
            var totalsRow = document.createElement('tr');
            totalsRow.className = 'totals-row';
            totalsRow.innerHTML = '<td>Total</td>' +
                '<td class="num primary">' + formatDuration(totalTime) + '</td>' +
                '<td class="num primary">' + Math.round(totalWork) + 'kJ</td>' +
                '<td class="num primary separator">' + Math.round(totalWork * 1.075) + '</td>' +
                '<td class="num">' + formatDist(totalDist) + '</td>' +
                '<td class="num">' + formatElev(totalElev) + '</td>' +
                '<td class="num"></td><td class="num">' + formatSteepTime(totalSteepTime) + '</td><td class="num"></td><td class="num"></td><td class="num"></td><td class="num"></td>';
            tbody.appendChild(totalsRow);
        }

        document.getElementById('analyzeForm').addEventListener('submit', function(e) {
            var mode = document.getElementById('mode').value;
            if (mode !== 'collection') {
                // For single routes, URL will be saved after results load (with name)
                return;
            }

            e.preventDefault();
            hideAllResults();

            var url = document.getElementById('url').value;
            var climbing_power = document.getElementById('climbing_power').value;
            var flat_power = document.getElementById('flat_power').value;
            var mass = document.getElementById('mass').value;
            var headwind = document.getElementById('headwind').value;

            var submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Analyzing...';

            document.getElementById('progressContainer').classList.remove('hidden');
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressText').textContent = 'Connecting...';
            document.getElementById('progressRoute').textContent = '';

            // Clear previous results
            document.getElementById('routesTableBody').innerHTML = '';
            collectionRoutes = [];
            originalRouteOrder = [];
            currentSortColumn = null;
            currentSortDirection = null;
            clearSortIndicators();

            var params = new URLSearchParams({
                url: url,
                climbing_power: climbing_power,
                flat_power: flat_power,
                descending_power: document.getElementById('descending_power').value,
                mass: mass,
                headwind: headwind,
                descent_braking_factor: document.getElementById('descent_braking_factor').value,
                gravel_grade: document.getElementById('gravel_grade').value,
                smoothing: document.getElementById('smoothing').value
            });

            var eventSource = new EventSource('/analyze-collection-stream?' + params.toString());

            eventSource.onmessage = function(event) {
                var data = JSON.parse(event.data);

                if (data.type === 'start') {
                    // Clear any previous route selection when starting new analysis
                    clearRouteSelection();
                    var collectionNameEl = document.getElementById('collectionName');
                    var nameText = data.name || 'Collection Analysis';
                    collectionNameEl.innerHTML = '<a href="' + url + '" target="_blank">' + nameText + '</a>';
                    document.getElementById('progressText').textContent =
                        'Analyzing route 0 of ' + data.total + '...';
                    // Update page title
                    document.title = nameText + ' | Reality Check my Route';
                    // Track collection analysis with Umami
                    if (typeof umami !== 'undefined') {
                        umami.track('analyze', {
                            type: 'collection',
                            url: url,
                            name: nameText
                        });
                    }
                    // Save URL with collection name
                    saveRecentUrl(url, data.name);
                    // Build share URL with all parameters
                    var shareParams = new URLSearchParams({
                        url: url,
                        climbing_power: document.getElementById('climbing_power').value,
                        flat_power: document.getElementById('flat_power').value,
                        descending_power: document.getElementById('descending_power').value,
                        mass: document.getElementById('mass').value,
                        headwind: document.getElementById('headwind').value,
                        descent_braking_factor: document.getElementById('descent_braking_factor').value,
                        gravel_grade: document.getElementById('gravel_grade').value,
                        smoothing: document.getElementById('smoothing').value
                    });
                    if (document.getElementById('imperial').checked) {
                        shareParams.set('imperial', '1');
                    }
                    var shareUrl = window.location.origin + window.location.pathname + '?' + shareParams.toString();
                    document.getElementById('collectionShareUrl').value = shareUrl;
                    // Update browser URL and title
                    history.pushState({}, nameText + ' | Reality Check my Route', shareUrl);
                } else if (data.type === 'progress') {
                    document.getElementById('progressText').textContent =
                        'Analyzing route ' + data.current + ' of ' + data.total + '...';
                    document.getElementById('progressRoute').textContent = '';
                } else if (data.type === 'route') {
                    collectionRoutes.push(data.route);
                    originalRouteOrder.push(data.route.route_id);
                    var r = data.route;

                    // Update progress bar to show completed route
                    var pct = (collectionRoutes.length / data.total * 100).toFixed(0);
                    document.getElementById('progressFill').style.width = pct + '%';
                    document.getElementById('progressRoute').textContent = r.name || '';

                    var row = document.createElement('tr');
                    var rwgpsUrl = 'https://ridewithgps.com/routes/' + r.route_id;
                    var analyzeUrl = buildAnalyzeUrl(rwgpsUrl);
                    row.innerHTML = '<td class="cmp-col"><input type="checkbox" class="route-select-checkbox" data-route-url="' + rwgpsUrl + '" data-route-id="' + r.route_id + '" onchange="toggleRouteSelection(this)"></td>' +
                        '<td class="route-name" title="' + r.name + '"><a href="' + analyzeUrl + '">' + r.name + '</a><a href="' + rwgpsUrl + '" target="_blank" class="rwgps-link" title="View on RideWithGPS">↗</a></td>' +
                        '<td class="num primary">' + formatTimeStr(r.time_str) + '</td>' +
                        '<td class="num primary">' + Math.round(r.work_kj) + '<span class="u">kJ</span></td>' +
                        '<td class="num primary separator">' + Math.round(r.work_kj * 1.075) + '<span class="u">kcal</span></td>' +
                        '<td class="num">' + formatDist(r.distance_km) + '</td>' +
                        '<td class="num">' + formatElev(r.elevation_m) + '</td>' +
                        '<td class="num">' + formatHilliness(r.hilliness_score || 0) + '</td>' +
                        '<td class="num">' + formatSteepTime(r.steep_time_seconds) + '</td>' +
                        '<td class="num">' + (r.steepness_score || 0).toFixed(1) + '<span class="u">%</span></td>' +
                        '<td class="num">' + formatSpeed(r.avg_speed_kmh) + '</td>' +
                        '<td class="num">' + Math.round(r.unpaved_pct || 0) + '<span class="u">%</span></td>' +
                        '<td class="num">' + r.elevation_scale.toFixed(2) + '</td>';
                    document.getElementById('routesTableBody').appendChild(row);

                    // Show results container and update totals
                    document.getElementById('collectionResults').classList.remove('hidden');
                    document.body.classList.add('collection-mode');
                    updateTotals(collectionRoutes);
                } else if (data.type === 'complete') {
                    eventSource.close();
                    document.getElementById('progressContainer').classList.add('hidden');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Analyze';
                } else if (data.type === 'error') {
                    eventSource.close();
                    showError(data.message);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Analyze';
                }
            };

            eventSource.onerror = function() {
                eventSource.close();
                showError('Connection lost. Please try again.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Analyze';
            };
        });

        // Store routes globally so we can re-render when units change
        var collectionRoutes = [];
        var originalRouteOrder = [];  // Stores route_ids in original load order

        // Route selection state for comparison (max 2 routes)
        var selectedRouteIds = [];  // Array of {url, routeId} objects

        function toggleRouteSelection(checkbox) {
            var url = checkbox.dataset.routeUrl;
            var routeId = checkbox.dataset.routeId;
            var row = checkbox.closest('tr');

            if (checkbox.checked) {
                // Add to selection (max 2)
                if (selectedRouteIds.length >= 2) {
                    // Deselect oldest
                    var oldest = selectedRouteIds.shift();
                    var oldRow = document.querySelector('input[data-route-id="' + oldest.routeId + '"]');
                    if (oldRow) {
                        oldRow.checked = false;
                        oldRow.closest('tr').classList.remove('selected-route');
                    }
                }
                selectedRouteIds.push({url: url, routeId: routeId});
                row.classList.add('selected-route');
            } else {
                // Remove from selection
                selectedRouteIds = selectedRouteIds.filter(function(item) {
                    return item.routeId !== routeId;
                });
                row.classList.remove('selected-route');
            }

            updateCompareActionBar();
        }

        function buildCompareUrl() {
            if (selectedRouteIds.length !== 2) return '#';

            // Build comparison URL with both routes and all params
            var params = collectAllParams();
            params.set('url', selectedRouteIds[0].url);
            params.set('url2', selectedRouteIds[1].url);

            return '/?' + params.toString();
        }

        function updateCompareActionBar() {
            var bar = document.getElementById('compareActionBar');
            var count = document.getElementById('compareSelectionCount');
            var link = document.getElementById('compareLink');
            count.textContent = selectedRouteIds.length;

            if (selectedRouteIds.length === 2) {
                bar.classList.add('visible');
                link.href = buildCompareUrl();
            } else {
                bar.classList.remove('visible');
                link.href = '#';
            }
        }

        function clearRouteSelection() {
            selectedRouteIds = [];
            var checkboxes = document.querySelectorAll('.route-select-checkbox');
            checkboxes.forEach(function(cb) {
                cb.checked = false;
                var row = cb.closest('tr');
                if (row) row.classList.remove('selected-route');
            });
            updateCompareActionBar();
        }

        function rerenderCollectionTable() {
            if (collectionRoutes.length === 0) return;

            var tbody = document.getElementById('routesTableBody');
            tbody.innerHTML = '';

            collectionRoutes.forEach(function(r) {
                var row = document.createElement('tr');
                var rwgpsUrl = 'https://ridewithgps.com/routes/' + r.route_id;
                var analyzeUrl = buildAnalyzeUrl(rwgpsUrl);
                // Check if this route was selected (preserve selection across rerender)
                var isSelected = selectedRouteIds.some(function(item) { return item.routeId === String(r.route_id); });
                if (isSelected) row.classList.add('selected-route');
                row.innerHTML = '<td class="cmp-col"><input type="checkbox" class="route-select-checkbox" data-route-url="' + rwgpsUrl + '" data-route-id="' + r.route_id + '" onchange="toggleRouteSelection(this)"' + (isSelected ? ' checked' : '') + '></td>' +
                    '<td class="route-name" title="' + r.name + '"><a href="' + analyzeUrl + '">' + r.name + '</a><a href="' + rwgpsUrl + '" target="_blank" class="rwgps-link" title="View on RideWithGPS">↗</a></td>' +
                    '<td class="num primary">' + formatTimeStr(r.time_str) + '</td>' +
                    '<td class="num primary">' + Math.round(r.work_kj) + '<span class="u">kJ</span></td>' +
                    '<td class="num primary separator">' + Math.round(r.work_kj * 1.075) + '<span class="u">kcal</span></td>' +
                    '<td class="num">' + formatDist(r.distance_km) + '</td>' +
                    '<td class="num">' + formatElev(r.elevation_m) + '</td>' +
                    '<td class="num">' + formatHilliness(r.hilliness_score || 0) + '</td>' +
                    '<td class="num">' + formatSteepTime(r.steep_time_seconds) + '</td>' +
                    '<td class="num">' + (r.steepness_score || 0).toFixed(1) + '<span class="u">%</span></td>' +
                    '<td class="num">' + formatSpeed(r.avg_speed_kmh) + '</td>' +
                    '<td class="num">' + Math.round(r.unpaved_pct || 0) + '<span class="u">%</span></td>' +
                    '<td class="num">' + r.elevation_scale.toFixed(2) + '</td>';
                tbody.appendChild(row);
            });

            updateTotals(collectionRoutes);
        }

        // Table sorting state
        var currentSortColumn = null;
        var currentSortDirection = null;  // null = default, 'asc', 'desc'

        function clearSortIndicators() {
            document.querySelectorAll('.collection-table th.sortable').forEach(function(th) {
                th.classList.remove('sorted');
                var indicator = th.querySelector('.sort-indicator');
                if (indicator) indicator.textContent = '';
            });
        }

        function sortTable(column) {
            // Three-state cycle: desc -> asc -> default (null)
            if (currentSortColumn === column) {
                if (currentSortDirection === 'desc') {
                    currentSortDirection = 'asc';
                } else if (currentSortDirection === 'asc') {
                    currentSortDirection = null;
                    currentSortColumn = null;
                } else {
                    currentSortDirection = 'desc';
                }
            } else {
                currentSortColumn = column;
                currentSortDirection = 'desc';
            }

            // Sort or restore original order
            if (currentSortDirection === null) {
                // Restore original order using originalRouteOrder
                collectionRoutes.sort(function(a, b) {
                    return originalRouteOrder.indexOf(a.route_id) - originalRouteOrder.indexOf(b.route_id);
                });
            } else {
                // Sort the routes array
                collectionRoutes.sort(function(a, b) {
                    var valA, valB;

                    if (column === 'name') {
                        valA = (a.name || '').toLowerCase();
                        valB = (b.name || '').toLowerCase();
                    } else if (column === 'energy') {
                        valA = (a.work_kj || 0) * 1.075;
                        valB = (b.work_kj || 0) * 1.075;
                    } else {
                        valA = a[column] || 0;
                        valB = b[column] || 0;
                    }

                    if (column === 'name') {
                        if (valA < valB) return currentSortDirection === 'asc' ? -1 : 1;
                        if (valA > valB) return currentSortDirection === 'asc' ? 1 : -1;
                        return 0;
                    } else {
                        return currentSortDirection === 'asc' ? valA - valB : valB - valA;
                    }
                });
            }

            // Update sort indicators
            clearSortIndicators();
            if (currentSortColumn) {
                var th = document.querySelector('.collection-table th[data-sort="' + currentSortColumn + '"]');
                if (th) {
                    th.classList.add('sorted');
                    var indicator = th.querySelector('.sort-indicator');
                    if (indicator) {
                        indicator.textContent = currentSortDirection === 'asc' ? ' \u25B2' : ' \u25BC';
                    }
                }
            }

            // Re-render the table
            rerenderCollectionTable();
        }

        function updateSingleRouteUnits() {
            var imperial = isImperial();
            var distEl = document.getElementById('singleDistance');
            var gainEl = document.getElementById('singleElevGain');
            var lossEl = document.getElementById('singleElevLoss');
            var speedEl = document.getElementById('singleSpeed');

            if (distEl) {
                var km = parseFloat(distEl.dataset.km);
                if (imperial) {
                    distEl.textContent = (km * 0.621371).toFixed(1) + ' mi';
                } else {
                    distEl.textContent = km.toFixed(1) + ' km';
                }
            }
            if (gainEl) {
                var m = parseFloat(gainEl.dataset.m);
                if (imperial) {
                    gainEl.textContent = Math.round(m * 3.28084) + ' ft';
                } else {
                    gainEl.textContent = Math.round(m) + ' m';
                }
            }
            if (lossEl) {
                var m = parseFloat(lossEl.dataset.m);
                if (imperial) {
                    lossEl.textContent = Math.round(m * 3.28084) + ' ft';
                } else {
                    lossEl.textContent = Math.round(m) + ' m';
                }
            }
            if (speedEl) {
                var kmh = parseFloat(speedEl.dataset.kmh);
                if (imperial) {
                    speedEl.textContent = (kmh * 0.621371).toFixed(1) + ' mph';
                } else {
                    speedEl.textContent = kmh.toFixed(1) + ' km/h';
                }
            }
            var hillyEl = document.getElementById('singleHilliness');
            if (hillyEl) {
                var mkm = parseFloat(hillyEl.dataset.mkm);
                if (imperial) {
                    // m/km to ft/mi: (3.28084 ft/m) / (0.621371 mi/km) ≈ 5.28
                    hillyEl.textContent = Math.round(mkm * 5.28) + ' ft/mi';
                } else {
                    hillyEl.textContent = Math.round(mkm) + ' m/km';
                }
            }
            // Steep distance stats (including comparison mode _2 variants)
            ['steepDist10', 'steepDist15', 'steepDist10_2', 'steepDist15_2'].forEach(function(id) {
                var el = document.getElementById(id);
                if (el && el.dataset.m) {
                    var m = parseFloat(el.dataset.m);
                    var secs = parseFloat(el.dataset.secs || 0);
                    var distStr = imperial ? (m * 0.000621371).toFixed(1) + ' mi' : (m / 1000).toFixed(1) + ' km';
                    var timeStr = '-';
                    if (secs >= 60) {
                        var mins = Math.round(secs / 60);
                        if (mins < 60) {
                            timeStr = mins + ' min';
                        } else {
                            var h = Math.floor(mins / 60);
                            var mm = mins % 60;
                            timeStr = h + 'h ' + (mm < 10 ? '0' : '') + mm + 'm';
                        }
                    } else if (secs > 0) {
                        timeStr = Math.round(secs) + ' s';
                    }
                    el.textContent = distStr + ' / ' + timeStr;
                }
            });
        }

        function getEnergyUnit() {
            return document.getElementById('energyUnitSelect')?.value || 'kcal';
        }

        function formatEnergy(kj) {
            if (kj === null || kj === undefined || isNaN(kj)) return '-';
            var kcal = kj * 1.075;  // Convert work to food calories
            var unit = getEnergyUnit();
            if (unit === 'bananas') {
                return (kcal / 100).toFixed(1) + ' bananas';
            } else if (unit === 'baguettes') {
                return (kcal / 680).toFixed(2) + ' baguettes';
            }
            return Math.round(kcal) + ' kcal';
        }

        function formatEnergyDiff(kj1, kj2) {
            if (kj1 === null || kj2 === null || isNaN(kj1) || isNaN(kj2)) return '-';
            var kcal1 = kj1 * 1.075;
            var kcal2 = kj2 * 1.075;
            var diff = kcal1 - kcal2;
            var unit = getEnergyUnit();
            var sign = diff > 0 ? '+' : '';
            if (unit === 'bananas') {
                return sign + (diff / 100).toFixed(1) + ' bananas';
            } else if (unit === 'baguettes') {
                return sign + (diff / 680).toFixed(2) + ' baguettes';
            }
            return sign + Math.round(diff) + ' kcal';
        }

        function updateEnergyUnits() {
            // Single route
            var el = document.getElementById('singleEnergy');
            if (el && el.dataset.kj) {
                el.textContent = formatEnergy(parseFloat(el.dataset.kj));
            }
            // Comparison mode
            ['1', '2'].forEach(function(n) {
                var el = document.getElementById('energy' + n);
                if (el && el.dataset.kj) {
                    el.textContent = formatEnergy(parseFloat(el.dataset.kj));
                }
            });
            // Comparison diff
            var diffEl = document.getElementById('energyDiff');
            if (diffEl && diffEl.dataset.kj1 && diffEl.dataset.kj2) {
                diffEl.textContent = formatEnergyDiff(parseFloat(diffEl.dataset.kj1), parseFloat(diffEl.dataset.kj2));
            }
            // Save preference
            try { localStorage.setItem('energyUnit', getEnergyUnit()); } catch (e) {}
        }

        function initEnergyUnit() {
            try {
                var saved = localStorage.getItem('energyUnit');
                if (saved) {
                    var select = document.getElementById('energyUnitSelect');
                    if (select) {
                        select.value = saved;
                        updateEnergyUnits();
                    }
                }
            } catch (e) {}
        }

        function updateComparisonTableUnits() {
            var imperial = isImperial();
            // Distance columns
            ['cmpDist1', 'cmpDist2', 'cmpDistDiff'].forEach(function(id) {
                var el = document.getElementById(id);
                if (el && el.dataset.km) {
                    var km = parseFloat(el.dataset.km);
                    var sign = (id.includes('Diff') && km > 0) ? '+' : '';
                    if (imperial) {
                        el.textContent = sign + (km * 0.621371).toFixed(1) + ' mi';
                    } else {
                        el.textContent = sign + km.toFixed(1) + ' km';
                    }
                }
            });
            // Elevation columns
            ['cmpElev1', 'cmpElev2', 'cmpElevDiff'].forEach(function(id) {
                var el = document.getElementById(id);
                if (el && el.dataset.m) {
                    var m = parseFloat(el.dataset.m);
                    var sign = (id.includes('Diff') && m > 0) ? '+' : '';
                    if (imperial) {
                        el.textContent = sign + Math.round(m * 3.28084) + ' ft';
                    } else {
                        el.textContent = sign + Math.round(m) + ' m';
                    }
                }
            });
            // Speed columns
            ['cmpSpeed1', 'cmpSpeed2', 'cmpSpeedDiff'].forEach(function(id) {
                var el = document.getElementById(id);
                if (el && el.dataset.kmh) {
                    var kmh = parseFloat(el.dataset.kmh);
                    var sign = (id.includes('Diff') && kmh > 0) ? '+' : '';
                    if (imperial) {
                        el.textContent = sign + (kmh * 0.621371).toFixed(1) + ' mph';
                    } else {
                        el.textContent = sign + kmh.toFixed(1) + ' km/h';
                    }
                }
            });
            // Hilliness columns
            ['cmpHilly1', 'cmpHilly2', 'cmpHillyDiff'].forEach(function(id) {
                var el = document.getElementById(id);
                if (el && el.dataset.mkm) {
                    var mkm = parseFloat(el.dataset.mkm);
                    var sign = (id.includes('Diff') && mkm > 0) ? '+' : '';
                    if (imperial) {
                        el.textContent = sign + Math.round(mkm * 5.28) + ' ft/mi';
                    } else {
                        el.textContent = sign + Math.round(mkm) + ' m/km';
                    }
                }
            });
        }

        document.getElementById('imperial').addEventListener('change', function() {
            rerenderCollectionTable();
            updateSingleRouteUnits();
            updateComparisonTableUnits();
            // Refresh elevation profiles if speed overlay is active (axis labels change units)
            var speedCheckbox = document.getElementById('overlay_speed');
            if (speedCheckbox && speedCheckbox.checked) {
                toggleOverlay('speed');
            }
        });

        // Auto-trigger collection analysis when loaded via shared link
        (function() {
            var mode = '{{ mode }}';
            var url = document.getElementById('url').value;
            if (mode === 'collection' && url && url.includes('/collections/')) {
                // Small delay to ensure page is fully loaded
                setTimeout(function() {
                    document.getElementById('analyzeForm').dispatchEvent(new Event('submit'));
                }, 100);
            }
        })();

        // Histogram bar tooltips (touch-friendly)
        (function() {
            var tooltip = null;

            function formatTime(seconds) {
                var hours = Math.floor(seconds / 3600);
                var mins = Math.floor((seconds % 3600) / 60);
                if (hours > 0) {
                    return hours + 'h ' + mins + 'm';
                }
                return mins + 'm';
            }

            function formatDistance(meters) {
                var imperial = isImperial();
                if (imperial) {
                    var miles = meters * 0.000621371;
                    return miles.toFixed(2) + ' mi';
                } else {
                    var km = meters / 1000;
                    return km.toFixed(2) + ' km';
                }
            }

            function showTooltip(bar, x, y) {
                if (!tooltip) {
                    tooltip = document.createElement('div');
                    tooltip.className = 'bar-tooltip';
                    document.body.appendChild(tooltip);
                }

                var name = bar.dataset.name || 'Route';
                var grade = bar.dataset.grade || '';
                var pct = parseFloat(bar.dataset.pct) || 0;
                var type = bar.dataset.type;
                var absValue = '';

                if (type === 'time') {
                    var seconds = parseFloat(bar.dataset.seconds) || 0;
                    absValue = formatTime(seconds);
                } else if (type === 'distance') {
                    var meters = parseFloat(bar.dataset.meters) || 0;
                    absValue = formatDistance(meters);
                }

                tooltip.innerHTML = '<div class="tooltip-title">' + name + '</div>' +
                    '<div class="tooltip-row"><span class="tooltip-label">Grade:</span><span>' + grade + '</span></div>' +
                    '<div class="tooltip-row"><span class="tooltip-label">' + (type === 'time' ? 'Time:' : 'Distance:') + '</span><span>' + pct.toFixed(1) + '%, ' + absValue + '</span></div>';

                tooltip.style.display = 'block';

                // Position tooltip - use bar's position for pinch-zoom compatibility
                var barRect = bar.getBoundingClientRect();
                var tooltipRect = tooltip.getBoundingClientRect();

                // Account for pinch-zoom using visualViewport if available
                var vv = window.visualViewport;
                var offsetX = vv ? vv.offsetLeft : 0;
                var offsetY = vv ? vv.offsetTop : 0;
                var scale = vv ? vv.scale : 1;

                // Calculate position relative to bar, adjusted for zoom
                var left = barRect.left + barRect.width / 2 - tooltipRect.width / 2 + offsetX;
                var top = barRect.top - tooltipRect.height - 10 + offsetY;

                // Get visible viewport bounds
                var viewWidth = vv ? vv.width : window.innerWidth;
                var viewHeight = vv ? vv.height : window.innerHeight;
                var viewLeft = offsetX;
                var viewTop = offsetY;

                // Keep tooltip within visible viewport
                if (left < viewLeft + 5) left = viewLeft + 5;
                if (left + tooltipRect.width > viewLeft + viewWidth - 5) {
                    left = viewLeft + viewWidth - tooltipRect.width - 5;
                }
                if (top < viewTop + 5) {
                    top = barRect.bottom + 10 + offsetY;  // Show below bar instead
                }

                tooltip.style.left = left + 'px';
                tooltip.style.top = top + 'px';
            }

            function hideTooltip() {
                if (tooltip) {
                    tooltip.style.display = 'none';
                }
            }

            // Find nearest bar in a container given touch X position
            function findNearestBar(container, touchX) {
                var bars = container.querySelectorAll('.bar-hover');
                if (bars.length === 0) return null;
                if (bars.length === 1) return bars[0];

                // Find which bar is closest to touch point
                var containerRect = container.getBoundingClientRect();
                var relativeX = touchX - containerRect.left;
                var containerWidth = containerRect.width;

                // In comparison mode, left half = first bar, right half = second bar
                if (relativeX < containerWidth / 2) {
                    return bars[0];
                } else {
                    return bars[1] || bars[0];
                }
            }

            // Event delegation for all bar-hover elements
            document.addEventListener('mouseover', function(e) {
                if (e.target.classList.contains('bar-hover')) {
                    var rect = e.target.getBoundingClientRect();
                    showTooltip(e.target, rect.left + rect.width / 2, rect.top);
                }
            });

            document.addEventListener('mouseout', function(e) {
                if (e.target.classList.contains('bar-hover')) {
                    hideTooltip();
                }
            });

            // Touch support - enhanced for better mobile UX
            document.addEventListener('touchstart', function(e) {
                var target = e.target;
                var touch = e.touches[0];

                // Direct touch on bar
                if (target.classList.contains('bar-hover')) {
                    e.preventDefault();
                    showTooltip(target, touch.clientX, touch.clientY - 50);
                    return;
                }

                // Touch on bar-container - find nearest bar
                var container = target.closest('.bar-container');
                if (container) {
                    var bar = findNearestBar(container, touch.clientX);
                    if (bar) {
                        e.preventDefault();
                        showTooltip(bar, touch.clientX, touch.clientY - 50);
                        return;
                    }
                }

                // Touch on histogram-bar (includes label area) - find bar in that group
                var histogramBar = target.closest('.histogram-bar');
                if (histogramBar) {
                    var barContainer = histogramBar.querySelector('.bar-container');
                    if (barContainer) {
                        var bar = findNearestBar(barContainer, touch.clientX);
                        if (bar) {
                            e.preventDefault();
                            showTooltip(bar, touch.clientX, touch.clientY - 50);
                            return;
                        }
                    }
                }

                hideTooltip();
            }, { passive: false });

            document.addEventListener('touchend', function(e) {
                // Hide tooltip immediately when finger is lifted
                hideTooltip();
            }, { passive: true });
        })();

    </script>

    {% if error %}
    <div class="error server-error">{{ error }}</div>
    {% endif %}

    {% if result %}
    <div class="results {% if is_trip %}trip-results{% else %}route-results{% endif %}" id="singleRouteResults">
        {% if share_url %}
        <input type="hidden" id="shareUrl" value="{{ share_url }}">
        {% endif %}
        <div class="results-header">
            {% if compare_mode and result2 %}
            <h2>Comparison</h2>
            {% else %}
            <h2>{{ result.name or ('Trip Analysis' if is_trip else 'Route Analysis') }}</h2>
            {% endif %}
            {% if not compare_mode %}
            <span class="result-badge {% if is_trip %}trip-badge{% else %}route-badge{% endif %}">
                {% if is_trip %}Recorded Ride{% else %}Planned Route{% endif %}
            </span>
            {% endif %}
            {% if share_url %}
            <button type="button" class="share-btn" onclick="copyShareLink('shareUrl', this)" title="Copy link to share">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>
                <span>Share</span>
            </button>
            {% endif %}
        </div>

        {% if compare_mode and result2 %}
        <!-- Comparison table -->
        <div class="comparison-table-wrapper">
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th class="route-col">{{ (result.name or ('Trip 1' if is_trip else 'Route 1'))|truncate(25) }} <span class="result-badge {% if is_trip %}trip-badge{% else %}route-badge{% endif %}">{% if is_trip %}Ride{% else %}Route{% endif %}</span></th>
                        <th class="route-col">{{ (result2.name or ('Trip 2' if is_trip2 else 'Route 2'))|truncate(25) }} <span class="result-badge {% if is_trip2 %}trip-badge{% else %}route-badge{% endif %}">{% if is_trip2 %}Ride{% else %}Route{% endif %}</span></th>
                        <th class="diff-col">Difference</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="primary">
                        <td>{% if is_trip or is_trip2 %}Moving Time{% else %}Est. Moving Time{% endif %}</td>
                        <td class="route-col">{{ result.time_str }}</td>
                        <td class="route-col">{{ result2.time_str }}</td>
                        <td class="diff-col">{{ format_time_diff(result.time_seconds, result2.time_seconds) }}</td>
                    </tr>
                    {% if (not is_trip or result.work_kj is not none) and (not is_trip2 or result2.work_kj is not none) %}
                    <tr class="primary">
                        <td>{% if is_trip or is_trip2 %}Work{% else %}Est. Work{% endif %}</td>
                        <td class="route-col">{% if result.work_kj is not none %}{{ "%.0f"|format(result.work_kj) }} kJ{% else %}-{% endif %}</td>
                        <td class="route-col">{% if result2.work_kj is not none %}{{ "%.0f"|format(result2.work_kj) }} kJ{% else %}-{% endif %}</td>
                        <td class="diff-col">{% if result.work_kj is not none and result2.work_kj is not none %}{{ format_diff(result.work_kj, result2.work_kj, 'kJ') }}{% else %}-{% endif %}</td>
                    </tr>
                    {% endif %}
                    {% if result.work_kj is not none or result2.work_kj is not none %}
                    <tr class="primary">
                        <td>{% if is_trip or is_trip2 %}Energy{% else %}Est. Energy{% endif %} <select id="energyUnitSelect" class="unit-select" onchange="updateEnergyUnits()"><option value="kcal">kcal</option><option value="bananas">Bananas</option><option value="baguettes">Baguettes</option></select></td>
                        <td class="route-col"><span id="energy1" data-kj="{{ result.work_kj if result.work_kj is not none else '' }}">{% if result.work_kj is not none %}{{ "%.0f"|format(result.work_kj * 1.075) }} kcal{% else %}-{% endif %}</span></td>
                        <td class="route-col"><span id="energy2" data-kj="{{ result2.work_kj if result2.work_kj is not none else '' }}">{% if result2.work_kj is not none %}{{ "%.0f"|format(result2.work_kj * 1.075) }} kcal{% else %}-{% endif %}</span></td>
                        <td class="diff-col"><span id="energyDiff" data-kj1="{{ result.work_kj if result.work_kj is not none else '' }}" data-kj2="{{ result2.work_kj if result2.work_kj is not none else '' }}">{% if result.work_kj is not none and result2.work_kj is not none %}{{ format_diff(result.work_kj * 1.075, result2.work_kj * 1.075, 'kcal') }}{% else %}-{% endif %}</span></td>
                    </tr>
                    {% endif %}
                    <tr class="primary">
                        <td>{% if is_trip or is_trip2 %}Avg Power{% else %}Est. Avg Power{% endif %}</td>
                        <td class="route-col">{% if result.avg_watts is not none %}{{ result.avg_watts|int }} W{% else %}-{% endif %}</td>
                        <td class="route-col">{% if result2.avg_watts is not none %}{{ result2.avg_watts|int }} W{% else %}-{% endif %}</td>
                        <td class="diff-col">{% if result.avg_watts is not none and result2.avg_watts is not none %}{{ format_diff(result.avg_watts, result2.avg_watts, 'W') }}{% else %}-{% endif %}</td>
                    </tr>
                    {% if (is_trip and result.avg_power_climbing is not none) or (is_trip2 and result2.avg_power_climbing is not none) %}
                    <tr>
                        <td><span class="label-with-info">Power (Climbing) <button type="button" class="info-btn" onclick="showModal('powerClimbingModal')">?</button></span></td>
                        <td class="route-col">{% if result.avg_power_climbing is not none %}{{ result.avg_power_climbing|int }} W{% else %}-{% endif %}</td>
                        <td class="route-col">{% if result2.avg_power_climbing is not none %}{{ result2.avg_power_climbing|int }} W{% else %}-{% endif %}</td>
                        <td class="diff-col">{% if result.avg_power_climbing is not none and result2.avg_power_climbing is not none %}{{ format_diff(result.avg_power_climbing, result2.avg_power_climbing, "W", 0) }}{% else %}-{% endif %}</td>
                    </tr>
                    <tr>
                        <td><span class="label-with-info">Power (Flat) <button type="button" class="info-btn" onclick="showModal('powerFlatModal')">?</button></span></td>
                        <td class="route-col">{% if result.avg_power_flat is not none %}{{ result.avg_power_flat|int }} W{% else %}-{% endif %}</td>
                        <td class="route-col">{% if result2.avg_power_flat is not none %}{{ result2.avg_power_flat|int }} W{% else %}-{% endif %}</td>
                        <td class="diff-col">{% if result.avg_power_flat is not none and result2.avg_power_flat is not none %}{{ format_diff(result.avg_power_flat, result2.avg_power_flat, "W", 0) }}{% else %}-{% endif %}</td>
                    </tr>
                    <tr>
                        <td><span class="label-with-info">Power (Descending) <button type="button" class="info-btn" onclick="showModal('powerDescendingModal')">?</button></span></td>
                        <td class="route-col">{% if result.avg_power_descending is not none %}{{ result.avg_power_descending|int }} W{% else %}-{% endif %}</td>
                        <td class="route-col">{% if result2.avg_power_descending is not none %}{{ result2.avg_power_descending|int }} W{% else %}-{% endif %}</td>
                        <td class="diff-col">{% if result.avg_power_descending is not none and result2.avg_power_descending is not none %}{{ format_diff(result.avg_power_descending, result2.avg_power_descending, "W", 0) }}{% else %}-{% endif %}</td>
                    </tr>
                    {% endif %}
                    {% if (is_trip and result.braking_factor is not none) or (is_trip2 and result2.braking_factor is not none) %}
                    <tr>
                        <td><span class="label-with-info">Braking Factor <button type="button" class="info-btn" onclick="showModal('brakingModal')">?</button></span></td>
                        <td class="route-col">{% if result.braking_factor is not none %}{{ "%.2f"|format(result.braking_factor) }}{% else %}-{% endif %}</td>
                        <td class="route-col">{% if result2.braking_factor is not none %}{{ "%.2f"|format(result2.braking_factor) }}{% else %}-{% endif %}</td>
                        <td class="diff-col">{% if result.braking_factor is not none and result2.braking_factor is not none %}{{ format_diff(result.braking_factor, result2.braking_factor, "", 2) }}{% else %}-{% endif %}</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <td>Distance</td>
                        <td class="route-col" id="cmpDist1" data-km="{{ result.distance_km }}">{{ "%.1f"|format(result.distance_km) }} km</td>
                        <td class="route-col" id="cmpDist2" data-km="{{ result2.distance_km }}">{{ "%.1f"|format(result2.distance_km) }} km</td>
                        <td class="diff-col" id="cmpDistDiff" data-km="{{ result.distance_km - result2.distance_km }}">{{ "%+.1f"|format(result.distance_km - result2.distance_km) }} km</td>
                    </tr>
                    <tr>
                        <td>Elevation Gain</td>
                        <td class="route-col" id="cmpElev1" data-m="{{ result.elevation_m }}">{{ "%.0f"|format(result.elevation_m) }} m</td>
                        <td class="route-col" id="cmpElev2" data-m="{{ result2.elevation_m }}">{{ "%.0f"|format(result2.elevation_m) }} m</td>
                        <td class="diff-col" id="cmpElevDiff" data-m="{{ result.elevation_m - result2.elevation_m }}">{{ "%+.0f"|format(result.elevation_m - result2.elevation_m) }} m</td>
                    </tr>
                    <tr>
                        <td>Avg Speed</td>
                        <td class="route-col" id="cmpSpeed1" data-kmh="{{ result.avg_speed_kmh }}">{{ "%.1f"|format(result.avg_speed_kmh) }} km/h</td>
                        <td class="route-col" id="cmpSpeed2" data-kmh="{{ result2.avg_speed_kmh }}">{{ "%.1f"|format(result2.avg_speed_kmh) }} km/h</td>
                        <td class="diff-col" id="cmpSpeedDiff" data-kmh="{{ result.avg_speed_kmh - result2.avg_speed_kmh }}">{{ "%+.1f"|format(result.avg_speed_kmh - result2.avg_speed_kmh) }} km/h</td>
                    </tr>
                    <tr>
                        <td><span class="label-with-info">Hilliness <button type="button" class="info-btn" onclick="showModal('hillyModal')">?</button></span></td>
                        <td class="route-col" id="cmpHilly1" data-mkm="{{ result.hilliness_score }}">{{ "%.0f"|format(result.hilliness_score) }} m/km</td>
                        <td class="route-col" id="cmpHilly2" data-mkm="{{ result2.hilliness_score }}">{{ "%.0f"|format(result2.hilliness_score) }} m/km</td>
                        <td class="diff-col" id="cmpHillyDiff" data-mkm="{{ result.hilliness_score - result2.hilliness_score }}">{{ "%+.0f"|format(result.hilliness_score - result2.hilliness_score) }} m/km</td>
                    </tr>
                    <tr>
                        <td><span class="label-with-info">Steepness <button type="button" class="info-btn" onclick="showModal('steepModal')">?</button></span></td>
                        <td class="route-col">{{ "%.1f"|format(result.steepness_score) }}%</td>
                        <td class="route-col">{{ "%.1f"|format(result2.steepness_score) }}%</td>
                        <td class="diff-col">{{ format_pct_diff(result.steepness_score, result2.steepness_score) }}</td>
                    </tr>
                    <tr>
                        <td><span class="label-with-info">&gt;10% <button type="button" class="info-btn" onclick="showModal('steepTimeModal')">?</button></span></td>
                        <td class="route-col">{% if result.steep_time_seconds and result.steep_time_seconds >= 60 %}{% set mins = (result.steep_time_seconds / 60)|round|int %}{% if mins < 60 %}{{ mins }} min{% else %}{{ mins // 60 }}h {{ "%02d"|format(mins % 60) }}m{% endif %}{% else %}-{% endif %}</td>
                        <td class="route-col">{% if result2.steep_time_seconds and result2.steep_time_seconds >= 60 %}{% set mins2 = (result2.steep_time_seconds / 60)|round|int %}{% if mins2 < 60 %}{{ mins2 }} min{% else %}{{ mins2 // 60 }}h {{ "%02d"|format(mins2 % 60) }}m{% endif %}{% else %}-{% endif %}</td>
                        <td class="diff-col">{% if result.steep_time_seconds and result2.steep_time_seconds %}{{ format_pct_diff(result.steep_time_seconds, result2.steep_time_seconds) }}{% else %}-{% endif %}</td>
                    </tr>
                    {% if result.unpaved_pct is not none and result2.unpaved_pct is not none %}
                    <tr>
                        <td>Unpaved</td>
                        <td class="route-col">{{ "%.0f"|format(result.unpaved_pct) }}%</td>
                        <td class="route-col">{{ "%.0f"|format(result2.unpaved_pct) }}%</td>
                        <td class="diff-col">{{ format_pct_diff(result.unpaved_pct, result2.unpaved_pct) }}</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        {% if not is_trip or not is_trip2 %}
        <div class="comparison-footnote">* Estimated from physics model</div>
        {% endif %}
        {% else %}
        <!-- Single route/trip results -->
        <div class="primary-results">
            <div class="result-row primary">
                <span class="result-label label-with-info">{% if is_trip %}Moving Time{% else %}Est. Moving Time{% endif %} <button type="button" class="info-btn" onclick="showModal('timeModal')">?</button></span>
                <span class="result-value">{{ result.time_str }}</span>
            </div>
            {% if not is_trip or result.work_kj is not none %}
            <div class="result-row primary">
                <span class="result-label label-with-info">{% if is_trip %}Work{% else %}Est. Work{% endif %} <button type="button" class="info-btn" onclick="showModal('workModal')">?</button></span>
                <span class="result-value">{% if result.work_kj is not none %}{{ "%.0f"|format(result.work_kj) }} kJ{% else %}-{% endif %}</span>
            </div>
            <div class="result-row primary">
                <span class="result-label label-with-info">{% if is_trip %}Energy{% else %}Est. Energy{% endif %} <button type="button" class="info-btn" onclick="showModal('energyModal')">?</button>
                    <select id="energyUnitSelect" class="unit-select" onchange="updateEnergyUnits()">
                        <option value="kcal">kcal</option>
                        <option value="bananas">Bananas</option>
                        <option value="baguettes">Baguettes</option>
                    </select>
                </span>
                <span class="result-value" id="singleEnergy" data-kj="{{ result.work_kj if result.work_kj is not none else '' }}">{% if result.work_kj is not none %}{{ "%.0f"|format(result.work_kj * 1.075) }} kcal{% else %}-{% endif %}</span>
            </div>
            {% endif %}
            {% if result.has_power and result.avg_watts is not none %}
            <div class="result-row primary">
                <span class="result-label">{% if is_trip %}Avg Power{% else %}Est. Avg Power{% endif %}</span>
                <span class="result-value">{{ result.avg_watts|int }} W</span>
            </div>
            {% endif %}
            {% if is_trip and result.avg_power_climbing is not none %}
            <div class="result-row">
                <span class="result-label label-with-info">Power (Climbing) <button type="button" class="info-btn" onclick="showModal('powerClimbingModal')">?</button></span>
                <span class="result-value">{{ result.avg_power_climbing|int }} W</span>
            </div>
            <div class="result-row">
                <span class="result-label label-with-info">Power (Flat) <button type="button" class="info-btn" onclick="showModal('powerFlatModal')">?</button></span>
                <span class="result-value">{% if result.avg_power_flat is not none %}{{ result.avg_power_flat|int }} W{% else %}-{% endif %}</span>
            </div>
            <div class="result-row">
                <span class="result-label label-with-info">Power (Descending) <button type="button" class="info-btn" onclick="showModal('powerDescendingModal')">?</button></span>
                <span class="result-value">{% if result.avg_power_descending is not none %}{{ result.avg_power_descending|int }} W{% else %}-{% endif %}</span>
            </div>
            {% endif %}
            {% if is_trip and result.braking_factor is not none %}
            <div class="result-row">
                <span class="result-label label-with-info">Braking Factor <button type="button" class="info-btn" onclick="showModal('brakingModal')">?</button></span>
                <span class="result-value">{{ "%.2f"|format(result.braking_factor) }}</span>
            </div>
            {% endif %}
        </div>

        <div class="result-row">
            <span class="result-label">Distance</span>
            <span class="result-value" id="singleDistance" data-km="{{ result.distance_km }}">{{ "%.1f"|format(result.distance_km) }} km</span>
        </div>
        <div class="result-row">
            <span class="result-label">Elevation Gain</span>
            <span class="result-value" id="singleElevGain" data-m="{{ result.elevation_m }}">{{ "%.0f"|format(result.elevation_m) }} m</span>
        </div>
        <div class="result-row">
            <span class="result-label">Elevation Loss</span>
            <span class="result-value" id="singleElevLoss" data-m="{{ result.elevation_loss_m }}">{{ "%.0f"|format(result.elevation_loss_m) }} m</span>
        </div>
        <div class="result-row">
            <span class="result-label">Avg Speed</span>
            <span class="result-value" id="singleSpeed" data-kmh="{{ result.avg_speed_kmh }}">{{ "%.1f"|format(result.avg_speed_kmh) }} km/h</span>
        </div>
        {% if result.unpaved_pct is not none %}
        <div class="result-row">
            <span class="result-label">Surface</span>
            <span class="result-value">{{ "%.0f"|format(result.unpaved_pct) }}% unpaved</span>
        </div>
        {% endif %}
        <div class="result-row">
            <span class="result-label label-with-info">Hilliness <button type="button" class="info-btn" onclick="showModal('hillyModal')">?</button></span>
            <span class="result-value" id="singleHilliness" data-mkm="{{ result.hilliness_score }}">{{ "%.0f"|format(result.hilliness_score) }} m/km</span>
        </div>
        <div class="result-row">
            <span class="result-label label-with-info">Steepness <button type="button" class="info-btn" onclick="showModal('steepModal')">?</button></span>
            <span class="result-value">{{ "%.1f"|format(result.steepness_score) }}%</span>
        </div>
        <div class="result-row">
            <span class="result-label label-with-info">&gt;10% <button type="button" class="info-btn" onclick="showModal('steepTimeModal')">?</button></span>
            <span class="result-value">{% if result.steep_time_seconds and result.steep_time_seconds >= 60 %}{% set mins = (result.steep_time_seconds / 60)|round|int %}{% if mins < 60 %}{{ mins }} min{% else %}{{ mins // 60 }}h {{ "%02d"|format(mins % 60) }}m{% endif %}{% else %}-{% endif %}</span>
        </div>
        {% endif %}

        {% if result.grade_histogram %}
        {% set labels = ['<-10', '-10', '-8', '-6', '-4', '-2', '0', '+2', '+4', '+6', '+8', '>10'] %}
        {% set bar_colors = ['#4a90d9', '#5a9fd9', '#6aaee0', '#7abde7', '#8acbef', '#9adaf6', '#cccccc', '#ffb399', '#ff9966', '#ff7f33', '#ff6600', '#e55a00'] %}
        <div class="histograms-container">
            <div class="grade-histogram">
                <h4>Time at Grade{% if compare_mode and result2 %} (Comparison){% endif %}</h4>
                <div class="histogram-bars{% if compare_mode and result2 %} comparison-mode{% endif %}">
                    {% set total_time = result.grade_histogram.values() | sum %}
                    {% set max_seconds = result.grade_histogram.values() | max %}
                    {% if compare_mode and result2 %}
                        {% set total_time_2 = result2.grade_histogram.values() | sum %}
                        {% set max_seconds_2 = result2.grade_histogram.values() | max %}
                        {% set max_seconds_both = [max_seconds, max_seconds_2] | max %}
                    {% endif %}
                    {% for label in result.grade_histogram.keys() %}
                    {% set seconds = result.grade_histogram[label] %}
                    {% set pct = (seconds / total_time * 100) if total_time > 0 else 0 %}
                    {% if compare_mode and result2 %}
                        {% set bar_height = (seconds / max_seconds_both * 100) if max_seconds_both > 0 else 0 %}
                    {% else %}
                        {% set bar_height = (seconds / max_seconds * 100) if max_seconds > 0 else 0 %}
                    {% endif %}
                    <div class="histogram-bar">
                        <div class="bar-container">
                            <div class="bar bar-hover" style="height: {{ bar_height }}%; background: {{ bar_colors[loop.index0] }};" data-name="{{ (result.name or 'Route 1')|truncate(25) }}" data-grade="{{ labels[loop.index0] }}%" data-pct="{{ '%.1f'|format(pct) }}" data-seconds="{{ seconds }}" data-type="time"></div>
                            {% if compare_mode and result2 %}
                            {% set seconds_2 = result2.grade_histogram[label] %}
                            {% set pct_2 = (seconds_2 / total_time_2 * 100) if total_time_2 > 0 else 0 %}
                            {% set bar_height_2 = (seconds_2 / max_seconds_both * 100) if max_seconds_both > 0 else 0 %}
                            <div class="bar route2 bar-hover" style="height: {{ bar_height_2 }}%; background: {{ bar_colors[loop.index0] }};" data-name="{{ (result2.name or 'Route 2')|truncate(25) }}" data-grade="{{ labels[loop.index0] }}%" data-pct="{{ '%.1f'|format(pct_2) }}" data-seconds="{{ seconds_2 }}" data-type="time"></div>
                            {% endif %}
                        </div>
                        <span class="label">{{ labels[loop.index0] }}</span>
                        {% if not (compare_mode and result2) %}
                        <span class="pct">{% if pct >= 1 %}{{ "%.0f"|format(pct) }}%{% else %}&nbsp;{% endif %}</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% if compare_mode and result2 %}
                <div class="histogram-legend">
                    <span class="legend-item"><span class="legend-color" style="background-color: #ff6600;"></span>{{ (result.name or 'Route 1')|truncate(20) }}</span>
                    <span class="legend-item"><span class="legend-color striped" style="background-color: #ff6600;"></span>{{ (result2.name or 'Route 2')|truncate(20) }}</span>
                </div>
                {% endif %}
            </div>
            <div class="grade-histogram">
                <h4>Distance at Grade{% if compare_mode and result2 %} (Comparison){% endif %}</h4>
                <div class="histogram-bars{% if compare_mode and result2 %} comparison-mode{% endif %}">
                    {% set total_dist = result.grade_distance_histogram.values() | sum %}
                    {% set max_dist = result.grade_distance_histogram.values() | max %}
                    {% if compare_mode and result2 %}
                        {% set total_dist_2 = result2.grade_distance_histogram.values() | sum %}
                        {% set max_dist_2 = result2.grade_distance_histogram.values() | max %}
                        {% set max_dist_both = [max_dist, max_dist_2] | max %}
                    {% endif %}
                    {% for label in result.grade_distance_histogram.keys() %}
                    {% set meters = result.grade_distance_histogram[label] %}
                    {% set pct = (meters / total_dist * 100) if total_dist > 0 else 0 %}
                    {% if compare_mode and result2 %}
                        {% set bar_height = (meters / max_dist_both * 100) if max_dist_both > 0 else 0 %}
                    {% else %}
                        {% set bar_height = (meters / max_dist * 100) if max_dist > 0 else 0 %}
                    {% endif %}
                    <div class="histogram-bar">
                        <div class="bar-container">
                            <div class="bar bar-hover" style="height: {{ bar_height }}%; background: {{ bar_colors[loop.index0] }};" data-name="{{ (result.name or 'Route 1')|truncate(25) }}" data-grade="{{ labels[loop.index0] }}%" data-pct="{{ '%.1f'|format(pct) }}" data-meters="{{ meters }}" data-type="distance"></div>
                            {% if compare_mode and result2 %}
                            {% set meters_2 = result2.grade_distance_histogram[label] %}
                            {% set pct_2 = (meters_2 / total_dist_2 * 100) if total_dist_2 > 0 else 0 %}
                            {% set bar_height_2 = (meters_2 / max_dist_both * 100) if max_dist_both > 0 else 0 %}
                            <div class="bar route2 bar-hover" style="height: {{ bar_height_2 }}%; background: {{ bar_colors[loop.index0] }};" data-name="{{ (result2.name or 'Route 2')|truncate(25) }}" data-grade="{{ labels[loop.index0] }}%" data-pct="{{ '%.1f'|format(pct_2) }}" data-meters="{{ meters_2 }}" data-type="distance"></div>
                            {% endif %}
                        </div>
                        <span class="label">{{ labels[loop.index0] }}</span>
                        {% if not (compare_mode and result2) %}
                        <span class="pct">{% if pct >= 1 %}{{ "%.0f"|format(pct) }}%{% else %}&nbsp;{% endif %}</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% if compare_mode and result2 %}
                <div class="histogram-legend">
                    <span class="legend-item"><span class="legend-color" style="background-color: #ff6600;"></span>{{ (result.name or 'Route 1')|truncate(20) }}</span>
                    <span class="legend-item"><span class="legend-color striped" style="background-color: #ff6600;"></span>{{ (result2.name or 'Route 2')|truncate(20) }}</span>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% if result.max_grade >= 10 or (compare_mode and result2 and result2.max_grade >= 10) %}
        <div class="steep-section">
            <h4><span class="th-with-info">Steep Climbs <button type="button" class="info-btn" onclick="showModal('steepClimbsModal')">?</button></span></h4>
            {% if compare_mode and result2 %}
            <table class="comparison-table steep-comparison-table">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>{{ (result.name or ('Trip 1' if is_trip else 'Route 1')) }} <span class="result-badge {% if is_trip %}trip-badge{% else %}route-badge{% endif %}">{% if is_trip %}Ride{% else %}Route{% endif %}</span></th>
                        <th>{{ (result2.name or ('Trip 2' if is_trip2 else 'Route 2')) }} <span class="result-badge {% if is_trip2 %}trip-badge{% else %}route-badge{% endif %}">{% if is_trip2 %}Ride{% else %}Route{% endif %}</span></th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Max Grade</td>
                        <td>{{ "%.1f"|format(result.max_grade) }}%</td>
                        <td>{{ "%.1f"|format(result2.max_grade) }}%</td>
                    </tr>
                    <tr>
                        <td>&gt;10%</td>
                        <td id="steepDist10" data-m="{{ result.steep_distance }}" data-secs="{{ result.steep_time_seconds|default(0) }}">{{ "%.1f"|format(result.steep_distance / 1000) }} km / {% set secs = result.steep_time_seconds|default(0) %}{% if secs >= 60 %}{% set mins = (secs / 60)|round|int %}{% if mins < 60 %}{{ mins }} min{% else %}{{ mins // 60 }}h {{ "%02d"|format(mins % 60) }}m{% endif %}{% elif secs > 0 %}{{ secs|int }} s{% else %}-{% endif %}</td>
                        <td id="steepDist10_2" data-m="{{ result2.steep_distance }}" data-secs="{{ result2.steep_time_seconds|default(0) }}">{{ "%.1f"|format(result2.steep_distance / 1000) }} km / {% set secs2 = result2.steep_time_seconds|default(0) %}{% if secs2 >= 60 %}{% set mins2 = (secs2 / 60)|round|int %}{% if mins2 < 60 %}{{ mins2 }} min{% else %}{{ mins2 // 60 }}h {{ "%02d"|format(mins2 % 60) }}m{% endif %}{% elif secs2 > 0 %}{{ secs2|int }} s{% else %}-{% endif %}</td>
                    </tr>
                    <tr>
                        <td>&gt;15%</td>
                        <td id="steepDist15" data-m="{{ result.very_steep_distance }}" data-secs="{{ result.very_steep_time_seconds|default(0) }}">{{ "%.1f"|format(result.very_steep_distance / 1000) }} km / {% set secs = result.very_steep_time_seconds|default(0) %}{% if secs >= 60 %}{% set mins = (secs / 60)|round|int %}{% if mins < 60 %}{{ mins }} min{% else %}{{ mins // 60 }}h {{ "%02d"|format(mins % 60) }}m{% endif %}{% elif secs > 0 %}{{ secs|int }} s{% else %}-{% endif %}</td>
                        <td id="steepDist15_2" data-m="{{ result2.very_steep_distance }}" data-secs="{{ result2.very_steep_time_seconds|default(0) }}">{{ "%.1f"|format(result2.very_steep_distance / 1000) }} km / {% set secs2 = result2.very_steep_time_seconds|default(0) %}{% if secs2 >= 60 %}{% set mins2 = (secs2 / 60)|round|int %}{% if mins2 < 60 %}{{ mins2 }} min{% else %}{{ mins2 // 60 }}h {{ "%02d"|format(mins2 % 60) }}m{% endif %}{% elif secs2 > 0 %}{{ secs2|int }} s{% else %}-{% endif %}</td>
                    </tr>
                </tbody>
            </table>
            {% else %}
            <div class="steep-stats">
                <div class="steep-stat">
                    <span class="steep-label">Max Grade</span>
                    <span class="steep-value">{{ "%.1f"|format(result.max_grade) }}%</span>
                </div>
                <div class="steep-stat">
                    <span class="steep-label">&gt;10%</span>
                    <span class="steep-value" id="steepDist10" data-m="{{ result.steep_distance }}" data-secs="{{ result.steep_time_seconds|default(0) }}">{{ "%.1f"|format(result.steep_distance / 1000) }} km / {% set secs = result.steep_time_seconds|default(0) %}{% if secs >= 60 %}{% set mins = (secs / 60)|round|int %}{% if mins < 60 %}{{ mins }} min{% else %}{{ mins // 60 }}h {{ "%02d"|format(mins % 60) }}m{% endif %}{% elif secs > 0 %}{{ secs|int }} s{% else %}-{% endif %}</span>
                </div>
                <div class="steep-stat">
                    <span class="steep-label">&gt;15%</span>
                    <span class="steep-value" id="steepDist15" data-m="{{ result.very_steep_distance }}" data-secs="{{ result.very_steep_time_seconds|default(0) }}">{{ "%.1f"|format(result.very_steep_distance / 1000) }} km / {% set secs = result.very_steep_time_seconds|default(0) %}{% if secs >= 60 %}{% set mins = (secs / 60)|round|int %}{% if mins < 60 %}{{ mins }} min{% else %}{{ mins // 60 }}h {{ "%02d"|format(mins % 60) }}m{% endif %}{% elif secs > 0 %}{{ secs|int }} s{% else %}-{% endif %}</span>
                </div>
            </div>
            {% endif %}
            {% set steep_labels = ['10-12', '12-14', '14-16', '16-18', '18-20', '>20'] %}
            {% set steep_colors = ['#e55a00', '#cc4400', '#b33300', '#992200', '#801100', '#660000'] %}
            <div class="histograms-container">
                <div class="grade-histogram">
                    <h4>Time at Steep Grade{% if compare_mode and result2 %} (Comparison){% endif %}</h4>
                    <div class="histogram-bars{% if compare_mode and result2 %} comparison-mode{% endif %}">
                        {% set max_steep_time = result.steep_time_histogram.values() | max %}
                        {% if compare_mode and result2 %}
                            {% set max_steep_time_2 = result2.steep_time_histogram.values() | max %}
                            {% set max_steep_time_both = [max_steep_time, max_steep_time_2] | max %}
                        {% endif %}
                        {% for label in result.steep_time_histogram.keys() %}
                        {% set seconds = result.steep_time_histogram[label] %}
                        {% set pct = (seconds / result.hilliness_total_time * 100) if result.hilliness_total_time > 0 else 0 %}
                        {% if compare_mode and result2 %}
                            {% set bar_height = (seconds / max_steep_time_both * 100) if max_steep_time_both > 0 else 0 %}
                        {% else %}
                            {% set bar_height = (seconds / max_steep_time * 100) if max_steep_time > 0 else 0 %}
                        {% endif %}
                        <div class="histogram-bar">
                            <div class="bar-container">
                                <div class="bar bar-hover" style="height: {{ bar_height }}%; background: {{ steep_colors[loop.index0] }};" data-name="{{ (result.name or 'Route 1')|truncate(25) }}" data-grade="{{ steep_labels[loop.index0] }}%" data-pct="{{ '%.1f'|format(pct) }}" data-seconds="{{ seconds }}" data-type="time"></div>
                                {% if compare_mode and result2 %}
                                {% set seconds_2 = result2.steep_time_histogram[label] %}
                                {% set pct_2 = (seconds_2 / result2.hilliness_total_time * 100) if result2.hilliness_total_time > 0 else 0 %}
                                {% set bar_height_2 = (seconds_2 / max_steep_time_both * 100) if max_steep_time_both > 0 else 0 %}
                                <div class="bar route2 bar-hover" style="height: {{ bar_height_2 }}%; background: {{ steep_colors[loop.index0] }};" data-name="{{ (result2.name or 'Route 2')|truncate(25) }}" data-grade="{{ steep_labels[loop.index0] }}%" data-pct="{{ '%.1f'|format(pct_2) }}" data-seconds="{{ seconds_2 }}" data-type="time"></div>
                                {% endif %}
                            </div>
                            <span class="label">{{ steep_labels[loop.index0] }}</span>
                            {% if not (compare_mode and result2) %}
                            <span class="pct">{% if pct >= 0.5 %}{{ "%.0f"|format(pct) }}%{% elif seconds > 0 %}<1%{% else %}&nbsp;{% endif %}</span>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% if compare_mode and result2 %}
                    <div class="histogram-legend">
                        <span class="legend-item"><span class="legend-color" style="background-color: #cc4400;"></span>{{ (result.name or 'Route 1')|truncate(20) }}</span>
                        <span class="legend-item"><span class="legend-color striped" style="background-color: #cc4400;"></span>{{ (result2.name or 'Route 2')|truncate(20) }}</span>
                    </div>
                    {% endif %}
                </div>
                <div class="grade-histogram">
                    <h4>Distance at Steep Grade{% if compare_mode and result2 %} (Comparison){% endif %}</h4>
                    <div class="histogram-bars{% if compare_mode and result2 %} comparison-mode{% endif %}">
                        {% set max_steep_dist = result.steep_distance_histogram.values() | max %}
                        {% if compare_mode and result2 %}
                            {% set max_steep_dist_2 = result2.steep_distance_histogram.values() | max %}
                            {% set max_steep_dist_both = [max_steep_dist, max_steep_dist_2] | max %}
                        {% endif %}
                        {% for label in result.steep_distance_histogram.keys() %}
                        {% set meters = result.steep_distance_histogram[label] %}
                        {% set pct = (meters / result.hilliness_total_distance * 100) if result.hilliness_total_distance > 0 else 0 %}
                        {% if compare_mode and result2 %}
                            {% set bar_height = (meters / max_steep_dist_both * 100) if max_steep_dist_both > 0 else 0 %}
                        {% else %}
                            {% set bar_height = (meters / max_steep_dist * 100) if max_steep_dist > 0 else 0 %}
                        {% endif %}
                        <div class="histogram-bar">
                            <div class="bar-container">
                                <div class="bar bar-hover" style="height: {{ bar_height }}%; background: {{ steep_colors[loop.index0] }};" data-name="{{ (result.name or 'Route 1')|truncate(25) }}" data-grade="{{ steep_labels[loop.index0] }}%" data-pct="{{ '%.1f'|format(pct) }}" data-meters="{{ meters }}" data-type="distance"></div>
                                {% if compare_mode and result2 %}
                                {% set meters_2 = result2.steep_distance_histogram[label] %}
                                {% set pct_2 = (meters_2 / result2.hilliness_total_distance * 100) if result2.hilliness_total_distance > 0 else 0 %}
                                {% set bar_height_2 = (meters_2 / max_steep_dist_both * 100) if max_steep_dist_both > 0 else 0 %}
                                <div class="bar route2 bar-hover" style="height: {{ bar_height_2 }}%; background: {{ steep_colors[loop.index0] }};" data-name="{{ (result2.name or 'Route 2')|truncate(25) }}" data-grade="{{ steep_labels[loop.index0] }}%" data-pct="{{ '%.1f'|format(pct_2) }}" data-meters="{{ meters_2 }}" data-type="distance"></div>
                                {% endif %}
                            </div>
                            <span class="label">{{ steep_labels[loop.index0] }}</span>
                            {% if not (compare_mode and result2) %}
                            <span class="pct">{% if pct >= 0.5 %}{{ "%.0f"|format(pct) }}%{% elif meters > 0 %}<1%{% else %}&nbsp;{% endif %}</span>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% if compare_mode and result2 %}
                    <div class="histogram-legend">
                        <span class="legend-item"><span class="legend-color" style="background-color: #cc4400;"></span>{{ (result.name or 'Route 1')|truncate(20) }}</span>
                        <span class="legend-item"><span class="legend-color striped" style="background-color: #cc4400;"></span>{{ (result2.name or 'Route 2')|truncate(20) }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        {% if result.elevation_scaled %}
        <div class="note">
            Elevation scaled {{ "%.2f"|format(result.elevation_scale) }}x to match RideWithGPS API data.
        </div>
        {% endif %}

        {% if result.noise_ratio and result.noise_ratio > 1.2 %}
        <div class="note noise-note">
            <span class="noise-badge" title="Ratio of raw GPS elevation gain to DEM elevation gain. Higher values indicate noisier GPS data.">
                Elevation noise: {{ "%.1f"|format(result.noise_ratio) }}x
                <button type="button" class="info-btn" onclick="showModal('noiseModal')" aria-label="Info about elevation noise">?</button>
            </span>
        </div>
        {% endif %}

        {% if result.tunnels_corrected > 0 %}
        <div class="note anomaly-note">
            <strong>{% if compare_mode %}{{ (result.name or 'Route 1')|truncate(20) }}: {% endif %}{{ result.tunnels_corrected }} anomal{{ 'ies' if result.tunnels_corrected > 1 else 'y' }} detected and corrected:</strong>
            {% for t in result.tunnel_corrections %}
            <span class="anomaly-item">{{ "%.1f"|format(t.start_km) }}-{{ "%.1f"|format(t.end_km) }} km ({{ "%.0f"|format(t.artificial_gain) }}m artificial gain removed)</span>{% if not loop.last %}, {% endif %}
            {% endfor %}
        </div>
        {% endif %}

        {% if compare_mode and result2 %}
        <!-- Stacked elevation profiles for comparison -->
        {% set t1_moving = result.time_seconds / 3600 %}
        {% set t1_elapsed = (result.elapsed_time_seconds | default(result.time_seconds)) / 3600 %}
        {% set t2_moving = result2.time_seconds / 3600 %}
        {% set t2_elapsed = (result2.elapsed_time_seconds | default(result2.time_seconds)) / 3600 %}
        {% set max_time_hours = [t1_elapsed, t2_elapsed] | max %}
        <div class="elevation-profiles-stacked">
            <div class="elevation-profile-header" style="margin-bottom: 8px;">
                <div class="elevation-profile-toggles">
                    <div class="collapse-stops-toggle">
                        <input type="checkbox" id="overlay_speed" onchange="toggleOverlay('speed')">
                        <label for="overlay_speed">Speed</label>
                    </div>
                    <div class="collapse-stops-toggle">
                        <input type="checkbox" id="overlay_grade" onchange="toggleOverlay('grade')">
                        <label for="overlay_grade">Grade</label>
                    </div>
                    {% if not is_trip or not is_trip2 %}
                    <div class="collapse-stops-toggle">
                        <input type="checkbox" id="overlay_gravel" onchange="toggleOverlay('gravel')">
                        <label for="overlay_gravel">Unpaved</label>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="elevation-profile">
                <div class="elevation-profile-header">
                    <h4><a href="{{ url }}" target="_blank">{{ (result.name or ('Trip 1' if is_trip else 'Route 1'))|truncate(40) }}</a> <span class="result-badge {% if is_trip %}trip-badge{% else %}route-badge{% endif %}">{% if is_trip %}Ride{% else %}Route{% endif %}</span> - {{ "%.1f"|format(result.time_seconds / 3600) }}h</h4>
                    {% if is_trip %}
                    <div class="collapse-stops-toggle">
                        <input type="checkbox" id="collapseStops1" onchange="toggleCollapseStops(1)">
                        <label for="collapseStops1">Moving time</label>
                    </div>
                    {% endif %}
                </div>
                <div class="elevation-profile-container" id="elevationContainer1"
                     data-url="{{ url|urlencode }}"
                     data-moving-time-hours="{{ '%.4f'|format(t1_moving) }}"
                     data-elapsed-time-hours="{{ '%.4f'|format(t1_elapsed) }}"
                     data-max-xlim-hours="{{ '%.4f'|format(max_time_hours) }}"
                     {% if compare_ylim %}data-max-ylim="{{ '%.2f'|format(compare_ylim) }}"{% endif %}
                     {% if compare_speed_ylim %}data-max-speed-ylim="{{ '%.2f'|format(compare_speed_ylim) }}"{% endif %}
                     {% if compare_grade_ylim %}data-max-grade-ylim="{{ '%.2f'|format(compare_grade_ylim) }}"{% endif %}
                     data-base-profile-url="/elevation-profile?url={{ url|urlencode }}&climbing_power={{ climbing_power }}&flat_power={{ flat_power }}&mass={{ mass }}&headwind={{ headwind }}&descending_power={{ descending_power }}&descent_braking_factor={{ descent_braking_factor }}&gravel_grade={{ gravel_grade }}&smoothing={{ smoothing|int }}{% if compare_ylim %}&max_ylim={{ '%.2f'|format(compare_ylim) }}{% endif %}{% if compare_speed_ylim %}&max_speed_ylim={{ '%.2f'|format(compare_speed_ylim) }}{% endif %}{% if compare_grade_ylim %}&max_grade_ylim={{ '%.2f'|format(compare_grade_ylim) }}{% endif %}"
                     data-base-data-url="/elevation-profile-data?url={{ url|urlencode }}&climbing_power={{ climbing_power }}&flat_power={{ flat_power }}&mass={{ mass }}&headwind={{ headwind }}&descending_power={{ descending_power }}&descent_braking_factor={{ descent_braking_factor }}&gravel_grade={{ gravel_grade }}&smoothing={{ smoothing|int }}">
                    <div class="elevation-loading" id="elevationLoading1">
                        <div class="elevation-spinner"></div>
                    </div>
                    <img src=""
                         alt="Elevation profile - Route 1" id="elevationImg1" class="loading"
                         onload="document.getElementById('elevationLoading1').classList.add('hidden'); this.classList.remove('loading');">
                    <div class="elevation-cursor" id="elevationCursor1"></div>
                    <div class="elevation-tooltip" id="elevationTooltip1">
                        <div class="grade">--</div>
                        <div class="elev">--</div>
                    </div>
                    <div class="elevation-selection" id="elevationSelection1"></div>
                    <div class="elevation-selection-popup" id="elevationSelectionPopup1" style="display: none;"></div>
                    <div class="zoom-out-link" id="zoomOutLink1" style="display: none;"><a href="#" onclick="return false;">Zoom Out</a></div>
                </div>
            </div>
            {% if result2.tunnels_corrected > 0 %}
            <div class="note anomaly-note" style="margin: 8px 0;">
                <strong>{{ (result2.name or 'Route 2')|truncate(20) }}: {{ result2.tunnels_corrected }} anomal{{ 'ies' if result2.tunnels_corrected > 1 else 'y' }} detected and corrected:</strong>
                {% for t in result2.tunnel_corrections %}
                <span class="anomaly-item">{{ "%.1f"|format(t.start_km) }}-{{ "%.1f"|format(t.end_km) }} km ({{ "%.0f"|format(t.artificial_gain) }}m artificial gain removed)</span>{% if not loop.last %}, {% endif %}
                {% endfor %}
            </div>
            {% endif %}
            <div class="elevation-profile">
                <div class="elevation-profile-header">
                    <h4><a href="{{ url2 }}" target="_blank">{{ (result2.name or ('Trip 2' if is_trip2 else 'Route 2'))|truncate(40) }}</a> <span class="result-badge {% if is_trip2 %}trip-badge{% else %}route-badge{% endif %}">{% if is_trip2 %}Ride{% else %}Route{% endif %}</span> - {{ "%.1f"|format(result2.time_seconds / 3600) }}h</h4>
                    {% if is_trip2 %}
                    <div class="collapse-stops-toggle">
                        <input type="checkbox" id="collapseStops2" onchange="toggleCollapseStops(2)">
                        <label for="collapseStops2">Moving time</label>
                    </div>
                    {% endif %}
                </div>
                <div class="elevation-profile-container" id="elevationContainer2"
                     data-url="{{ url2|urlencode }}"
                     data-moving-time-hours="{{ '%.4f'|format(t2_moving) }}"
                     data-elapsed-time-hours="{{ '%.4f'|format(t2_elapsed) }}"
                     data-max-xlim-hours="{{ '%.4f'|format(max_time_hours) }}"
                     {% if compare_ylim %}data-max-ylim="{{ '%.2f'|format(compare_ylim) }}"{% endif %}
                     {% if compare_speed_ylim %}data-max-speed-ylim="{{ '%.2f'|format(compare_speed_ylim) }}"{% endif %}
                     {% if compare_grade_ylim %}data-max-grade-ylim="{{ '%.2f'|format(compare_grade_ylim) }}"{% endif %}
                     data-base-profile-url="/elevation-profile?url={{ url2|urlencode }}&climbing_power={{ climbing_power }}&flat_power={{ flat_power }}&mass={{ mass }}&headwind={{ headwind }}&descending_power={{ descending_power }}&descent_braking_factor={{ descent_braking_factor }}&gravel_grade={{ gravel_grade }}&smoothing={{ smoothing|int }}{% if compare_ylim %}&max_ylim={{ '%.2f'|format(compare_ylim) }}{% endif %}{% if compare_speed_ylim %}&max_speed_ylim={{ '%.2f'|format(compare_speed_ylim) }}{% endif %}{% if compare_grade_ylim %}&max_grade_ylim={{ '%.2f'|format(compare_grade_ylim) }}{% endif %}"
                     data-base-data-url="/elevation-profile-data?url={{ url2|urlencode }}&climbing_power={{ climbing_power }}&flat_power={{ flat_power }}&mass={{ mass }}&headwind={{ headwind }}&descending_power={{ descending_power }}&descent_braking_factor={{ descent_braking_factor }}&gravel_grade={{ gravel_grade }}&smoothing={{ smoothing|int }}">
                    <div class="elevation-loading" id="elevationLoading2">
                        <div class="elevation-spinner"></div>
                    </div>
                    <img src=""
                         alt="Elevation profile - Route 2" id="elevationImg2" class="loading"
                         onload="document.getElementById('elevationLoading2').classList.add('hidden'); this.classList.remove('loading');">
                    <div class="elevation-cursor" id="elevationCursor2"></div>
                    <div class="elevation-tooltip" id="elevationTooltip2">
                        <div class="grade">--</div>
                        <div class="elev">--</div>
                    </div>
                    <div class="elevation-selection" id="elevationSelection2"></div>
                    <div class="elevation-selection-popup" id="elevationSelectionPopup2" style="display: none;"></div>
                    <div class="zoom-out-link" id="zoomOutLink2" style="display: none;"><a href="#" onclick="return false;">Zoom Out</a></div>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Single elevation profile -->
        <div class="elevation-profile">
            <div class="elevation-profile-header">
                <h4><a href="{{ url }}" target="_blank">{{ result.name or ('Trip' if is_trip else 'Route') }}</a> - {{ "%.1f"|format(result.time_seconds / 3600) }}h</h4>
                <div class="elevation-profile-toggles">
                    {% if is_trip %}
                    <div class="collapse-stops-toggle">
                        <input type="checkbox" id="collapseStops" onchange="toggleCollapseStops()">
                        <label for="collapseStops">Show moving time only</label>
                    </div>
                    {% endif %}
                    <div class="collapse-stops-toggle">
                        <input type="checkbox" id="overlay_speed" onchange="toggleOverlay('speed')">
                        <label for="overlay_speed">Speed</label>
                    </div>
                    <div class="collapse-stops-toggle">
                        <input type="checkbox" id="overlay_grade" onchange="toggleOverlay('grade')">
                        <label for="overlay_grade">Grade</label>
                    </div>
                    {% if not is_trip %}
                    <div class="collapse-stops-toggle">
                        <input type="checkbox" id="overlay_gravel" onchange="toggleOverlay('gravel')">
                        <label for="overlay_gravel">Unpaved</label>
                    </div>
                    {% endif %}
                </div>
                {% if not is_trip %}
                <a href="#" class="ride-link" id="viewClimbsLink" onclick="goToRidePage(); return false;" style="font-size: 0.85em; color: #4CAF50;">View Climbs &rarr;</a>
                {% endif %}
            </div>
            <div class="elevation-profile-container" id="elevationContainer"
                 data-url="{{ url|urlencode }}"
                 data-base-profile-url="/elevation-profile?url={{ url|urlencode }}&climbing_power={{ climbing_power }}&flat_power={{ flat_power }}&mass={{ mass }}&headwind={{ headwind }}&descending_power={{ descending_power }}&descent_braking_factor={{ descent_braking_factor }}&gravel_grade={{ gravel_grade }}&smoothing={{ smoothing|int }}"
                 data-base-data-url="/elevation-profile-data?url={{ url|urlencode }}&climbing_power={{ climbing_power }}&flat_power={{ flat_power }}&mass={{ mass }}&headwind={{ headwind }}&descending_power={{ descending_power }}&descent_braking_factor={{ descent_braking_factor }}&gravel_grade={{ gravel_grade }}&smoothing={{ smoothing|int }}">
                <div class="elevation-loading" id="elevationLoading">
                    <div class="elevation-spinner"></div>
                </div>
                <img src="/elevation-profile?url={{ url|urlencode }}&climbing_power={{ climbing_power }}&flat_power={{ flat_power }}&mass={{ mass }}&headwind={{ headwind }}&descending_power={{ descending_power }}&descent_braking_factor={{ descent_braking_factor }}&gravel_grade={{ gravel_grade }}&smoothing={{ smoothing|int }}"
                     alt="Elevation profile" id="elevationImg" class="loading"
                     onload="document.getElementById('elevationLoading').classList.add('hidden'); this.classList.remove('loading');">
                <div class="elevation-cursor" id="elevationCursor"></div>
                <div class="elevation-tooltip" id="elevationTooltip">
                    <div class="grade">--</div>
                    <div class="elev">--</div>
                </div>
                <div class="elevation-selection" id="elevationSelection"></div>
                <div class="elevation-selection-popup" id="elevationSelectionPopup" style="display: none;"></div>
                <div class="zoom-out-link" id="zoomOutLink" style="display: none;"><a href="#" onclick="return false;">Zoom Out</a></div>
            </div>
        </div>
        {% endif %}

        {% if compare_mode and route_id and route_id2 %}
        <!-- Side-by-side RWGPS embeds for comparison (only for routes, trips don't support embeds) -->
        {% if not is_trip and not is_trip2 %}
        <div class="route-maps-comparison">
            <div class="route-map">
                <h4>{{ (result.name or 'Route 1')|truncate(30) }}</h4>
                <iframe src="https://ridewithgps.com/embeds?type=route&id={{ route_id }}&sampleGraph=true{% if privacy_code %}&privacy_code={{ privacy_code }}{% endif %}"
                        scrolling="no"></iframe>
            </div>
            <div class="route-map">
                <h4>{{ (result2.name or 'Route 2')|truncate(30) }}</h4>
                <iframe src="https://ridewithgps.com/embeds?type=route&id={{ route_id2 }}&sampleGraph=true{% if privacy_code2 %}&privacy_code={{ privacy_code2 }}{% endif %}"
                        scrolling="no"></iframe>
            </div>
        </div>
        {% elif not is_trip and is_trip2 %}
        <!-- Only first is a route -->
        <div class="route-map">
            <h4>{{ (result.name or 'Route')|truncate(30) }}</h4>
            <iframe src="https://ridewithgps.com/embeds?type=route&id={{ route_id }}&sampleGraph=true{% if privacy_code %}&privacy_code={{ privacy_code }}{% endif %}"
                    scrolling="no"></iframe>
        </div>
        {% elif is_trip and not is_trip2 %}
        <!-- Only second is a route -->
        <div class="route-map">
            <h4>{{ (result2.name or 'Route')|truncate(30) }}</h4>
            <iframe src="https://ridewithgps.com/embeds?type=route&id={{ route_id2 }}&sampleGraph=true{% if privacy_code2 %}&privacy_code={{ privacy_code2 }}{% endif %}"
                    scrolling="no"></iframe>
        </div>
        {% endif %}
        {% elif route_id and not is_trip %}
        <!-- Single RWGPS embed (only for routes) -->
        <div class="route-map">
            <iframe src="https://ridewithgps.com/embeds?type=route&id={{ route_id }}&sampleGraph=true{% if privacy_code %}&privacy_code={{ privacy_code }}{% endif %}"
                    scrolling="no"></iframe>
        </div>
        {% endif %}
    </div>
    <script>
        // Save URL with route/trip name for recent URLs dropdown
        saveRecentUrl('{{ url }}', '{{ result.name|e if result.name else '' }}');
        {% if compare_mode and url2 and result2 %}
        // Also save the second URL when comparing
        saveRecentUrl('{{ url2 }}', '{{ result2.name|e if result2.name else '' }}');
        {% endif %}
        // Initialize units display
        updateSingleRouteUnits();
        updateComparisonTableUnits();
        initEnergyUnit();

        // Elevation profile hover interaction
        // Setup function for a single profile (global so toggleCollapseStops/toggleOverlay can call it)
        // maxXlimHours: optional max x-axis time (for synchronized comparison profiles)
        window.setupElevationProfile = function(containerId, imgId, tooltipId, cursorId, dataUrl, maxXlimHours) {
            const container = document.getElementById(containerId);
            const img = document.getElementById(imgId);
            const tooltip = document.getElementById(tooltipId);
            const cursor = document.getElementById(cursorId);
            if (!container || !img || !tooltip || !cursor) return;

            // Derive selection element IDs from container suffix
            const suffix = containerId.replace('elevationContainer', '');
            const selection = document.getElementById('elevationSelection' + suffix);
            const selectionPopup = document.getElementById('elevationSelectionPopup' + suffix);

            let profileData = null;
            let xlimHours = maxXlimHours || null;

            // Selection state
            let selectionStart = null;  // xPct where drag started
            let isSelecting = false;
            let selectionActive = false;

            // Zoom state - restore from container data attributes if present
            const savedZoomMin = container.getAttribute('data-zoom-min');
            const savedZoomMax = container.getAttribute('data-zoom-max');
            let isZoomed = !!(savedZoomMin && savedZoomMax);
            let zoomMinHours = savedZoomMin ? parseFloat(savedZoomMin) : null;
            let zoomMaxHours = savedZoomMax ? parseFloat(savedZoomMax) : null;
            let selectionStartTime = null;
            let selectionEndTime = null;
            const zoomOutLink = document.getElementById('zoomOutLink' + suffix);

            // Clear any stale popup and selection from previous initialization
            if (selectionPopup) { selectionPopup.style.display = 'none'; selectionPopup.innerHTML = ''; }
            if (selection) selection.classList.remove('visible');

            // Show/hide zoom out link based on restored state
            if (zoomOutLink) {
                zoomOutLink.style.display = isZoomed ? 'block' : 'none';
                if (isZoomed) {
                    zoomOutLink.querySelector('a').onclick = function(e) {
                        e.preventDefault();
                        zoomOut();
                    };
                }
            }

            // Fetch profile data
            fetch(dataUrl)
                .then(r => {
                    if (!r.ok) {
                        console.error('Profile data fetch failed:', r.status, r.statusText, dataUrl);
                        return { error: 'HTTP ' + r.status };
                    }
                    return r.json();
                })
                .then(data => {
                    if (data && !data.error) {
                        profileData = data;
                        if (!xlimHours) xlimHours = profileData.total_time;
                    } else if (data && data.error) {
                        console.error('Profile data error:', data.error, dataUrl);
                    }
                })
                .catch(err => console.error('Profile data fetch exception:', err, dataUrl));

            // The plot area margins match _set_fixed_margins() for figsize=(14,4)
            // Left: 0.7in/14in = 0.05, Right: 1 - 0.7in/14in = 0.95
            // These are constant regardless of speed overlay (overlay shares same plot area)
            const plotLeftPct = 0.05;
            const plotRightPct = 0.95;

            function getDataAtPosition(xPct) {
                if (!profileData || !profileData.times || profileData.times.length < 2) return null;

                const plotXPct = (xPct - plotLeftPct) / (plotRightPct - plotLeftPct);
                if (plotXPct < 0 || plotXPct > 1) return null;

                // Use zoom bounds if zoomed, otherwise full range
                const minTime = isZoomed ? zoomMinHours : 0;
                const maxTime = isZoomed ? zoomMaxHours : (xlimHours || profileData.total_time);
                const time = minTime + plotXPct * (maxTime - minTime);
                if (time > profileData.total_time || time < 0) return null;

                for (let i = 0; i < profileData.times.length - 1; i++) {
                    if (time >= profileData.times[i] && time < profileData.times[i + 1]) {
                        return {
                            grade: profileData.grades[i],
                            elevation: profileData.elevations[i] || 0,
                            speed: profileData.speeds ? profileData.speeds[i] : null,
                            time: time
                        };
                    }
                }
                const lastIdx = profileData.grades.length - 1;
                return {
                    grade: profileData.grades[lastIdx],
                    elevation: profileData.elevations[lastIdx + 1] || 0,
                    speed: profileData.speeds ? profileData.speeds[lastIdx] : null,
                    time: time
                };
            }

            function getIndexAtPosition(xPct) {
                if (!profileData || !profileData.times || profileData.times.length < 2) return -1;
                // Clamp to plot boundaries so extremities still work
                const plotXPct = Math.max(0, Math.min(1, (xPct - plotLeftPct) / (plotRightPct - plotLeftPct)));
                // Use zoom bounds if zoomed
                const minTime = isZoomed ? zoomMinHours : 0;
                const maxTime = isZoomed ? zoomMaxHours : (xlimHours || profileData.total_time);
                const time = Math.max(0, Math.min(minTime + plotXPct * (maxTime - minTime), profileData.total_time));
                for (let i = 0; i < profileData.times.length - 1; i++) {
                    if (time >= profileData.times[i] && time < profileData.times[i + 1]) return i;
                }
                return profileData.times.length - 2;
            }

            // Convert time to index (for selection repositioning after zoom)
            function getIndexAtTime(time) {
                if (!profileData || !profileData.times || profileData.times.length < 2) return -1;
                for (let i = 0; i < profileData.times.length - 1; i++) {
                    if (time >= profileData.times[i] && time < profileData.times[i + 1]) return i;
                }
                return profileData.times.length - 2;
            }

            function formatGrade(g) {
                if (g === null || g === undefined) return 'Stopped';
                const sign = g >= 0 ? '+' : '';
                return sign + g.toFixed(1) + '%';
            }

            function formatTime(hours) {
                const h = Math.floor(hours);
                const m = Math.floor((hours - h) * 60);
                return h + 'h ' + m.toString().padStart(2, '0') + 'm';
            }

            function formatDuration(hours) {
                const totalMin = Math.round(hours * 60);
                if (totalMin < 60) return totalMin + 'min';
                const h = Math.floor(totalMin / 60);
                const m = totalMin % 60;
                return h + 'h ' + m.toString().padStart(2, '0') + 'm';
            }

            // Tooltip helpers
            function updateTooltip(xPct, clientX) {
                const data = getDataAtPosition(xPct);
                if (data) {
                    tooltip.querySelector('.grade').textContent = formatGrade(data.grade);
                    const elevUnit = isImperial() ? 'ft' : 'm';
                    const elevVal = isImperial() ? data.elevation * 3.28084 : data.elevation;
                    var speedText = '';
                    if (data.speed !== null && data.speed !== undefined) {
                        var speedUnit = isImperial() ? 'mph' : 'km/h';
                        var speedVal = isImperial() ? data.speed * 0.621371 : data.speed;
                        speedText = ' | ' + speedVal.toFixed(1) + ' ' + speedUnit;
                    }
                    tooltip.querySelector('.elev').textContent = Math.round(elevVal) + ' ' + elevUnit + speedText + ' | ' + formatTime(data.time);

                    const rect = img.getBoundingClientRect();
                    const xPos = clientX - rect.left;
                    tooltip.style.left = xPos + 'px';
                    tooltip.style.bottom = '60px';
                    tooltip.classList.add('visible');
                    cursor.style.left = xPos + 'px';
                    cursor.classList.add('visible');
                } else {
                    hideTooltip();
                }
            }

            function hideTooltip() {
                tooltip.classList.remove('visible');
                cursor.classList.remove('visible');
            }

            // Selection helpers
            function updateSelectionHighlight(startXPct, endXPct) {
                if (!selection) return;
                // Clamp to plot area so highlight doesn't extend into axis margins
                const clampedStart = Math.max(plotLeftPct, Math.min(plotRightPct, startXPct));
                const clampedEnd = Math.max(plotLeftPct, Math.min(plotRightPct, endXPct));
                const left = Math.min(clampedStart, clampedEnd) * 100;
                const right = Math.max(clampedStart, clampedEnd) * 100;
                selection.style.left = left + '%';
                selection.style.width = (right - left) + '%';
                selection.classList.add('visible');
            }

            function computeSelectionStats(startIdx, endIdx) {
                if (!profileData) return null;
                const d = profileData;
                const i = Math.min(startIdx, endIdx);
                const j = Math.max(startIdx, endIdx);
                if (i < 0 || j >= d.times.length) return null;

                // Duration (hours)
                const duration = d.times[j + 1 < d.times.length ? j + 1 : j] - d.times[i];

                // Distance (meters -> km)
                let distM = 0;
                if (d.distances) {
                    for (let k = i; k <= j; k++) distM += (d.distances[k] || 0);
                }
                const distKm = distM / 1000;

                // Elevation gain/loss - use pre-computed arrays to survive downsampling
                let elevGain = 0, elevLoss = 0;
                if (d.elev_gains && d.elev_losses) {
                    for (let k = i; k <= j; k++) {
                        elevGain += (d.elev_gains[k] || 0);
                        elevLoss += (d.elev_losses[k] || 0);
                    }
                } else {
                    for (let k = i; k <= j; k++) {
                        const diff = (d.elevations[k + 1] !== undefined ? d.elevations[k + 1] : d.elevations[k]) - d.elevations[k];
                        if (diff > 0) elevGain += diff;
                        else elevLoss += diff;
                    }
                }

                // Avg grade
                let gradeSum = 0, gradeCount = 0;
                for (let k = i; k <= j; k++) {
                    if (d.grades[k] !== null && d.grades[k] !== undefined) {
                        gradeSum += d.grades[k];
                        gradeCount++;
                    }
                }
                const avgGrade = gradeCount > 0 ? gradeSum / gradeCount : null;

                // Avg speed (km/h) = total distance / total time
                const avgSpeed = (duration > 0 && distKm > 0) ? distKm / duration : null;

                // Total work (using pre-computed works array for accuracy)
                let workJ = 0;
                if (d.works) {
                    for (let k = i; k <= j; k++) {
                        workJ += (d.works[k] || 0);
                    }
                } else if (d.powers) {
                    // Fall back to power*time if works not available
                    for (let k = i; k <= j; k++) {
                        if (d.powers[k] !== null && d.powers[k] !== undefined) {
                            const dt = ((d.times[k + 1 < d.times.length ? k + 1 : k] - d.times[k]) * 3600);
                            workJ += d.powers[k] * dt;
                        }
                    }
                }
                // Avg power = work / time (matches summary calculation)
                const durationSec = duration * 3600;
                const avgPower = (workJ > 0 && durationSec > 0) ? workJ / durationSec : null;
                const workKJ = workJ / 1000;

                return { duration, distKm, elevGain, elevLoss, avgGrade, avgSpeed, avgPower, workKJ };
            }

            function showSelectionPopup(stats, xPctCenter) {
                if (!selectionPopup || !stats) return;
                const imp = isImperial();
                const distVal = imp ? (stats.distKm * 0.621371) : stats.distKm;
                const distUnit = imp ? 'mi' : 'km';
                const elevGainVal = imp ? (stats.elevGain * 3.28084) : stats.elevGain;
                const elevLossVal = imp ? (stats.elevLoss * 3.28084) : stats.elevLoss;
                const elevUnit = imp ? 'ft' : 'm';
                const speedVal = stats.avgSpeed !== null ? (imp ? stats.avgSpeed * 0.621371 : stats.avgSpeed) : null;
                const speedUnit = imp ? 'mph' : 'km/h';

                let html = '<span class="selection-close">&times;</span>';
                html += '<div class="selection-stat"><span class="stat-label">Duration</span><span class="stat-value">' + formatDuration(stats.duration) + '</span></div>';
                html += '<div class="selection-stat"><span class="stat-label">Distance</span><span class="stat-value">' + distVal.toFixed(1) + ' ' + distUnit + '</span></div>';
                html += '<div class="selection-stat"><span class="stat-label">Elev Gain</span><span class="stat-value">+' + Math.round(elevGainVal) + ' ' + elevUnit + '</span></div>';
                html += '<div class="selection-stat"><span class="stat-label">Elev Loss</span><span class="stat-value">' + Math.round(elevLossVal) + ' ' + elevUnit + '</span></div>';
                if (stats.avgGrade !== null) {
                    html += '<div class="selection-stat"><span class="stat-label">Avg Grade</span><span class="stat-value">' + formatGrade(stats.avgGrade) + '</span></div>';
                }
                if (speedVal !== null) {
                    html += '<div class="selection-stat"><span class="stat-label">Avg Speed</span><span class="stat-value">' + speedVal.toFixed(1) + ' ' + speedUnit + '</span></div>';
                }
                if (stats.avgPower !== null) {
                    html += '<div class="selection-stat"><span class="stat-label">Avg Power</span><span class="stat-value">' + Math.round(stats.avgPower) + ' W</span></div>';
                    html += '<div class="selection-stat"><span class="stat-label">Work</span><span class="stat-value">' + stats.workKJ.toFixed(1) + ' kJ</span></div>';
                }

                // Add zoom button
                html += '<div class="selection-zoom-btn">' + (isZoomed ? 'Zoom Out' : 'Zoom In') + '</div>';

                selectionPopup.innerHTML = html;
                selectionPopup.style.display = 'block';
                selectionPopup.style.left = (xPctCenter * 100) + '%';
                selectionPopup.style.bottom = '70px';
                selectionActive = true;

                // Close button handler
                var closeBtn = selectionPopup.querySelector('.selection-close');
                if (closeBtn) {
                    closeBtn.addEventListener('click', function(ev) {
                        ev.stopPropagation();
                        clearSelection();
                    });
                }

                // Zoom button handler
                var zoomBtn = selectionPopup.querySelector('.selection-zoom-btn');
                if (zoomBtn) {
                    zoomBtn.addEventListener('click', function(ev) {
                        ev.stopPropagation();
                        if (isZoomed) {
                            zoomOut();
                        } else {
                            zoomIn();
                        }
                    });
                }
            }

            function clearSelection() {
                if (selection) selection.classList.remove('visible');
                if (selectionPopup) { selectionPopup.style.display = 'none'; selectionPopup.innerHTML = ''; }
                selectionStart = null;
                isSelecting = false;
                selectionActive = false;
            }

            function zoomIn() {
                if (!profileData || !selection) return;

                // Get selection bounds in pixel percentages
                const selLeft = parseFloat(selection.style.left) / 100;
                const selWidth = parseFloat(selection.style.width) / 100;

                // Convert to time using current zoom state
                const plotRange = plotRightPct - plotLeftPct;
                const minTime = isZoomed ? zoomMinHours : 0;
                const maxTime = isZoomed ? zoomMaxHours : (xlimHours || profileData.total_time);
                const viewRange = maxTime - minTime;

                const startPct = (selLeft - plotLeftPct) / plotRange;
                const endPct = (selLeft + selWidth - plotLeftPct) / plotRange;

                selectionStartTime = minTime + startPct * viewRange;
                selectionEndTime = minTime + endPct * viewRange;

                // Calculate zoom bounds with padding so selection takes 90% of view
                const selectionDuration = selectionEndTime - selectionStartTime;
                const totalZoomRange = selectionDuration / 0.9;
                const padding = (totalZoomRange - selectionDuration) / 2;

                zoomMinHours = Math.max(0, selectionStartTime - padding);
                zoomMaxHours = Math.min(profileData.total_time, selectionEndTime + padding);

                // Store zoom state on container for persistence across overlay toggles
                container.setAttribute('data-zoom-min', zoomMinHours.toFixed(4));
                container.setAttribute('data-zoom-max', zoomMaxHours.toFixed(4));

                isZoomed = true;
                refreshZoomedProfile();
            }

            function zoomOut() {
                isZoomed = false;
                zoomMinHours = null;
                zoomMaxHours = null;
                selectionStartTime = null;
                selectionEndTime = null;

                // Clear zoom state from container
                container.removeAttribute('data-zoom-min');
                container.removeAttribute('data-zoom-max');

                clearSelection();
                refreshZoomedProfile();
            }

            function refreshZoomedProfile() {
                var baseProfileUrl = container.getAttribute('data-base-profile-url');
                var baseDataUrl = container.getAttribute('data-base-data-url');
                var loading = document.getElementById('elevationLoading' + suffix);

                if (!baseProfileUrl) return;

                // Build URL parameters
                var params = '';
                var collapseCheckbox = document.getElementById('collapseStops' + suffix);
                if (collapseCheckbox && collapseCheckbox.checked) params += '&collapse_stops=true';
                if (typeof _buildOverlayParams === 'function') params += _buildOverlayParams();

                // Add zoom parameters
                if (isZoomed && zoomMinHours !== null && zoomMaxHours !== null) {
                    params += '&min_xlim_hours=' + zoomMinHours.toFixed(4);
                    params += '&max_xlim_hours=' + zoomMaxHours.toFixed(4);
                }

                // Show loading spinner
                if (loading) loading.classList.remove('hidden');
                img.classList.add('loading');

                // Update image
                img.src = baseProfileUrl + params;

                img.onload = function() {
                    if (loading) loading.classList.add('hidden');
                    img.classList.remove('loading');

                    // Show/hide zoom out link
                    if (zoomOutLink) {
                        zoomOutLink.style.display = isZoomed ? 'block' : 'none';
                        if (isZoomed) {
                            zoomOutLink.querySelector('a').onclick = function(e) {
                                e.preventDefault();
                                zoomOut();
                            };
                        }
                    }

                    // Reposition selection if zoomed
                    if (isZoomed && selectionStartTime !== null && selectionEndTime !== null) {
                        repositionSelectionAfterZoom();
                    }
                };
            }

            function repositionSelectionAfterZoom() {
                if (!selection || !isZoomed || selectionStartTime === null || selectionEndTime === null) return;

                // Calculate the new position of selection in zoomed view
                const zoomRange = zoomMaxHours - zoomMinHours;
                const plotRange = plotRightPct - plotLeftPct;

                // Convert time to plot percentage
                const startPct = plotLeftPct + ((selectionStartTime - zoomMinHours) / zoomRange) * plotRange;
                const endPct = plotLeftPct + ((selectionEndTime - zoomMinHours) / zoomRange) * plotRange;

                // Clamp to plot boundaries
                const clampedStart = Math.max(plotLeftPct, Math.min(plotRightPct, startPct));
                const clampedEnd = Math.max(plotLeftPct, Math.min(plotRightPct, endPct));

                selection.style.left = (Math.min(clampedStart, clampedEnd) * 100) + '%';
                selection.style.width = (Math.abs(clampedEnd - clampedStart) * 100) + '%';
                selection.classList.add('visible');

                // Re-show popup with Zoom Out button
                const centerXPct = (clampedStart + clampedEnd) / 2;
                const startIdx = getIndexAtTime(selectionStartTime);
                const endIdx = getIndexAtTime(selectionEndTime);
                const stats = computeSelectionStats(startIdx, endIdx);
                if (stats) {
                    showSelectionPopup(stats, centerXPct);
                }
            }

            // Event handlers
            function onMouseMove(e) {
                if (!profileData) {
                    // Uncomment for debugging: console.log('No profile data yet for', containerId);
                    return;
                }
                const rect = img.getBoundingClientRect();
                const xPct = (e.clientX - rect.left) / rect.width;

                if (isSelecting) {
                    updateSelectionHighlight(selectionStart, xPct);
                    updateTooltip(xPct, e.clientX);
                } else if (!selectionActive) {
                    updateTooltip(xPct, e.clientX);
                }
            }

            function onMouseDown(e) {
                if (!profileData) return;
                // If popup is showing and click is outside popup, dismiss popup but keep selection if zoomed
                if (selectionActive) {
                    // Don't dismiss if clicking inside the popup
                    if (selectionPopup && selectionPopup.contains(e.target)) {
                        return;
                    }
                    if (selectionPopup) {
                        selectionPopup.style.display = 'none';
                        selectionPopup.innerHTML = '';
                    }
                    selectionActive = false;
                    // Keep selection visible if zoomed
                    if (!isZoomed && selection) {
                        selection.classList.remove('visible');
                    }
                    return;
                }
                const rect = img.getBoundingClientRect();
                selectionStart = (e.clientX - rect.left) / rect.width;
                isSelecting = true;
                e.preventDefault();
            }

            function onMouseUp(e) {
                if (!isSelecting) return;
                isSelecting = false;
                const rect = img.getBoundingClientRect();
                const xPctEnd = (e.clientX - rect.left) / rect.width;
                const dragPx = Math.abs(e.clientX - rect.left - selectionStart * rect.width);

                if (dragPx > 5) {
                    const startIdx = getIndexAtPosition(selectionStart);
                    const endIdx = getIndexAtPosition(xPctEnd);
                    if (startIdx >= 0 && endIdx >= 0 && startIdx !== endIdx) {
                        const stats = computeSelectionStats(startIdx, endIdx);
                        const centerXPct = (selectionStart + xPctEnd) / 2;
                        hideTooltip();
                        showSelectionPopup(stats, centerXPct);
                    } else {
                        clearSelection();
                    }
                } else {
                    clearSelection();
                }
            }

            function onMouseLeave(e) {
                if (isSelecting) {
                    // Finish selection on leave
                    onMouseUp(e);
                }
                hideTooltip();
            }

            // Long-press touch selection
            const LONG_PRESS_DURATION = 400;  // ms to trigger long-press
            const LONG_PRESS_MOVE_THRESHOLD = 15;  // px movement allowed during long-press wait
            let longPressTimer = null;
            let longPressStartX = 0;
            let longPressStartY = 0;
            let longPressPending = false;

            // Create long-press indicator element
            let longPressIndicator = container.querySelector('.long-press-indicator');
            if (!longPressIndicator) {
                longPressIndicator = document.createElement('div');
                longPressIndicator.className = 'long-press-indicator';
                longPressIndicator.innerHTML = '<div class="long-press-ring"></div>';
                container.appendChild(longPressIndicator);
            }

            function showLongPressIndicator(clientX, clientY) {
                const rect = container.getBoundingClientRect();
                longPressIndicator.style.left = (clientX - rect.left) + 'px';
                longPressIndicator.style.top = (clientY - rect.top) + 'px';
                longPressIndicator.classList.add('active');
            }

            function hideLongPressIndicator() {
                longPressIndicator.classList.remove('active');
            }

            function triggerHapticFeedback() {
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            }

            function cancelLongPress() {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
                longPressPending = false;
                hideLongPressIndicator();
            }

            function onTouchStart(e) {
                if (!profileData) return;
                // If popup is showing, check if tap is inside popup
                if (selectionActive) {
                    // Don't dismiss if tapping inside the popup
                    if (selectionPopup && e.touches[0] && selectionPopup.contains(document.elementFromPoint(e.touches[0].clientX, e.touches[0].clientY))) {
                        return;
                    }
                    if (selectionPopup) {
                        selectionPopup.style.display = 'none';
                        selectionPopup.innerHTML = '';
                    }
                    selectionActive = false;
                    // Keep selection visible if zoomed
                    if (!isZoomed && selection) {
                        selection.classList.remove('visible');
                    }
                    return;
                }

                const touch = e.touches[0];
                longPressStartX = touch.clientX;
                longPressStartY = touch.clientY;
                longPressPending = true;

                // Show visual indicator immediately
                showLongPressIndicator(touch.clientX, touch.clientY);

                // Start long-press timer
                longPressTimer = setTimeout(() => {
                    if (!longPressPending) return;
                    longPressPending = false;
                    hideLongPressIndicator();

                    // Trigger haptic feedback
                    triggerHapticFeedback();

                    // Enter selection mode
                    const rect = img.getBoundingClientRect();
                    selectionStart = (touch.clientX - rect.left) / rect.width;
                    isSelecting = true;

                    // Show initial selection highlight at touch point
                    updateSelectionHighlight(selectionStart, selectionStart);
                }, LONG_PRESS_DURATION);
            }

            function onTouchMove(e) {
                if (!profileData) return;

                const touch = e.touches[0];

                // If waiting for long-press, check if moved too much
                if (longPressPending) {
                    const dx = touch.clientX - longPressStartX;
                    const dy = touch.clientY - longPressStartY;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance > LONG_PRESS_MOVE_THRESHOLD) {
                        // User is scrolling, cancel long-press
                        cancelLongPress();
                        return;
                    }
                    // Still waiting for long-press, don't prevent default (allow scroll)
                    return;
                }

                // In selection mode - prevent scrolling and update selection
                if (isSelecting) {
                    e.preventDefault();
                    const rect = img.getBoundingClientRect();
                    const xPct = (touch.clientX - rect.left) / rect.width;
                    updateSelectionHighlight(selectionStart, xPct);
                    updateTooltip(xPct, touch.clientX);
                }
            }

            function onTouchEnd(e) {
                // Cancel any pending long-press
                if (longPressPending) {
                    cancelLongPress();
                    hideTooltip();
                    return;
                }

                if (!isSelecting) { hideTooltip(); return; }
                isSelecting = false;
                if (!selection) { hideTooltip(); return; }

                const rect = img.getBoundingClientRect();
                const selLeft = parseFloat(selection.style.left) / 100;
                const selWidth = parseFloat(selection.style.width) / 100;
                if (selWidth * rect.width > 30) {
                    const startIdx = getIndexAtPosition(selLeft);
                    const endIdx = getIndexAtPosition(selLeft + selWidth);
                    if (startIdx >= 0 && endIdx >= 0 && startIdx !== endIdx) {
                        const stats = computeSelectionStats(startIdx, endIdx);
                        hideTooltip();
                        showSelectionPopup(stats, selLeft + selWidth / 2);
                    } else clearSelection();
                } else clearSelection();
                hideTooltip();
            }

            function onTouchCancel(e) {
                cancelLongPress();
                if (isSelecting) {
                    isSelecting = false;
                    clearSelection();
                }
                hideTooltip();
            }

            function onKeyDown(e) {
                if (e.key === 'Escape') clearSelection();
            }

            // Clean up old listeners if this profile was previously set up
            if (container._profileCleanup) {
                container._profileCleanup();
            }

            var abortController = new AbortController();
            container.addEventListener('mousemove', onMouseMove, { signal: abortController.signal });
            container.addEventListener('mousedown', onMouseDown, { signal: abortController.signal });
            container.addEventListener('mouseup', onMouseUp, { signal: abortController.signal });
            container.addEventListener('mouseleave', onMouseLeave, { signal: abortController.signal });
            container.addEventListener('touchstart', onTouchStart, { passive: true, signal: abortController.signal });
            container.addEventListener('touchmove', onTouchMove, { passive: false, signal: abortController.signal });
            container.addEventListener('touchend', onTouchEnd, { passive: true, signal: abortController.signal });
            container.addEventListener('touchcancel', onTouchCancel, { passive: true, signal: abortController.signal });
            document.addEventListener('keydown', onKeyDown, { signal: abortController.signal });

            container._profileCleanup = function() {
                abortController.abort();
            };
        };

        (function() {
            // Check for comparison mode (two profiles)
            var container1 = document.getElementById('elevationContainer1');
            var container2 = document.getElementById('elevationContainer2');
            if (container1 && container2) {
                // Comparison mode - setup both profiles with synchronized x-axis
                var maxXlimHours = parseFloat(container1.getAttribute('data-max-xlim-hours')) || null;
                window.setupElevationProfile(
                    'elevationContainer1', 'elevationImg1', 'elevationTooltip1', 'elevationCursor1',
                    '/elevation-profile-data?url={{ url|urlencode }}&climbing_power={{ climbing_power }}&flat_power={{ flat_power }}&mass={{ mass }}&headwind={{ headwind }}&descending_power={{ descending_power }}&descent_braking_factor={{ descent_braking_factor }}&gravel_grade={{ gravel_grade }}&smoothing={{ smoothing|int }}',
                    maxXlimHours
                );
                window.setupElevationProfile(
                    'elevationContainer2', 'elevationImg2', 'elevationTooltip2', 'elevationCursor2',
                    '/elevation-profile-data?url={{ url2|urlencode if url2 else "" }}&climbing_power={{ climbing_power }}&flat_power={{ flat_power }}&mass={{ mass }}&headwind={{ headwind }}&descending_power={{ descending_power }}&descent_braking_factor={{ descent_braking_factor }}&gravel_grade={{ gravel_grade }}&smoothing={{ smoothing|int }}',
                    maxXlimHours
                );
                // Initialize settings (skip refresh, we'll load profiles once below)
                initCollapseStops(true);
                initOverlays(true);
                // Load profiles once with correct overlay/collapse params
                _refreshComparisonProfiles();
            } else {
                // Single route mode
                window.setupElevationProfile(
                    'elevationContainer', 'elevationImg', 'elevationTooltip', 'elevationCursor',
                    '/elevation-profile-data?url={{ url|urlencode }}&climbing_power={{ climbing_power }}&flat_power={{ flat_power }}&mass={{ mass }}&headwind={{ headwind }}&descending_power={{ descending_power }}&descent_braking_factor={{ descent_braking_factor }}&gravel_grade={{ gravel_grade }}&smoothing={{ smoothing|int }}'
                );
                // Initialize settings from localStorage (may trigger refresh)
                initCollapseStops();
                initOverlays();
            }
        })();
    </script>
    {% endif %}

    <div class="footer">
        <div class="footer-content">
            <div class="footer-links">
                <a href="https://github.com/sanmi/gpx-analyzer" target="_blank">Source Code</a>
                <a href="https://github.com/sanmi/gpx-analyzer/issues" target="_blank">Report a Bug</a>
            </div>
            <div class="footer-version">{{ version_date }} ({{ git_hash }})</div>
            <div class="footer-copyright">© 2025 Frank San Miguel</div>
        </div>
    </div>
    {% if umami_website_id and result %}
    <script>
        // Track analysis with Umami (wait for script to load)
        window.addEventListener('load', function() {
            if (typeof umami !== 'undefined') {
                {% if compare_mode and result2 %}
                umami.track('analyze', {
                    type: '{{ "trip" if is_trip else "route" }}',
                    compare: true,
                    url: '{{ url }}',
                    distance_km: {{ "%.1f"|format(result.distance_km) }},
                    elevation_m: {{ "%.0f"|format(result.elevation_m) }},
                    name: '{{ result.name|replace("'", "\\'") if result.name else "" }}'
                });
                umami.track('analyze', {
                    type: '{{ "trip" if is_trip2 else "route" }}',
                    compare: true,
                    url: '{{ url2 }}',
                    distance_km: {{ "%.1f"|format(result2.distance_km) }},
                    elevation_m: {{ "%.0f"|format(result2.elevation_m) }},
                    name: '{{ result2.name|replace("'", "\\'") if result2.name else "" }}'
                });
                {% else %}
                umami.track('analyze', {
                    type: '{{ "trip" if is_trip else "route" }}',
                    url: '{{ url }}',
                    distance_km: {{ "%.1f"|format(result.distance_km) }},
                    elevation_m: {{ "%.0f"|format(result.elevation_m) }},
                    name: '{{ result.name|replace("'", "\\'") if result.name else "" }}'
                });
                {% endif %}
            }
        });
    </script>
    {% endif %}
</body>
</html>
