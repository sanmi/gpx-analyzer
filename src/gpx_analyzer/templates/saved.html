<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saved Routes | Reality Check my Route</title>

    <!-- PWA meta tags -->
    <meta name="theme-color" content="#FF6B35">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GPX Analyzer">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/apple-touch-icon.png') }}">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/ride.css') }}">
    {% if umami_website_id %}
    <script defer src="{{ umami_script_url }}" data-website-id="{{ umami_website_id }}"></script>
    {% endif %}
    <script defer src="{{ url_for('static', filename='js/sw-register.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/offline-storage.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/offline-status.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/router.js') }}"></script>
</head>
<body>
    <div class="header-section">
        <div class="logo-container">
            <svg class="logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="mountainGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#FF6B35"/>
                        <stop offset="100%" style="stop-color:#F7931E"/>
                    </linearGradient>
                </defs>
                <path d="M0 85 L25 45 L40 60 L60 30 L80 50 L100 85 Z" fill="url(#mountainGrad)"/>
                <path d="M60 30 L67 42 L53 42 Z" fill="white" opacity="0.85"/>
                <path d="M25 45 L30 52 L20 52 Z" fill="white" opacity="0.7"/>
                <g transform="translate(18, 50) rotate(-20) scale(1.5)">
                    <circle cx="0" cy="14" r="7" fill="none" stroke="#2D3047" stroke-width="1.5"/>
                    <circle cx="22" cy="14" r="7" fill="none" stroke="#2D3047" stroke-width="1.5"/>
                    <path d="M0 14 L8 6 L18 6 L22 14 M8 6 L11 14 L18 6 M11 14 L0 14"
                          fill="none" stroke="#2D3047" stroke-width="1.5" stroke-linejoin="round"/>
                    <line x1="8" y1="6" x2="7" y2="3" stroke="#2D3047" stroke-width="1.5"/>
                    <line x1="7" y1="3" x2="14" y2="-1" stroke="#2D3047" stroke-width="2" stroke-linecap="round"/>
                    <circle cx="16" cy="-2" r="2.5" fill="#2D3047"/>
                    <line x1="12" y1="-1" x2="18" y2="5" stroke="#2D3047" stroke-width="1.5" stroke-linecap="round"/>
                </g>
            </svg>
            <h1>Reality Check my Route</h1>
        </div>
    </div>

    <main id="app-content">
    <a href="/" class="back-link">&larr; Back to Analysis</a>
    <div class="saved-routes-page">
        <h2>My Saved Routes</h2>

        <div class="storage-stats" id="storageStats">
            <p>Loading storage info...</p>
        </div>

        <div id="routesLoading" class="loading">
            Loading saved routes...
        </div>

        <ul class="saved-routes-list" id="savedRoutesList" style="display: none;">
        </ul>

        <div class="empty-state" id="emptyState" style="display: none;">
            <p>No routes saved for offline use yet.</p>
            <p>Analyze a route, then click <strong>"Save Offline"</strong> to access it without internet.</p>
            <p><a href="/">Go to Analysis</a></p>
        </div>

        <button type="button" class="clear-all-btn" id="clearAllBtn" style="display: none;" onclick="clearAllSaved()">
            Clear All Saved Data
        </button>
    </div>

    <script>
        // Format date
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Format size
        function formatSize(kb) {
            if (kb < 1024) return kb + ' KB';
            return (kb / 1024).toFixed(1) + ' MB';
        }

        // Format duration (seconds to Xh Ymin)
        function formatDuration(seconds) {
            var hours = Math.floor(seconds / 3600);
            var minutes = Math.floor((seconds % 3600) / 60);
            if (hours > 0) {
                return hours + 'h ' + (minutes < 10 ? '0' : '') + minutes + 'min';
            }
            return minutes + ' min';
        }

        // Load and display saved routes
        async function loadSavedRoutes() {
            const loadingEl = document.getElementById('routesLoading');
            const listEl = document.getElementById('savedRoutesList');
            const emptyEl = document.getElementById('emptyState');
            const clearBtn = document.getElementById('clearAllBtn');
            const statsEl = document.getElementById('storageStats');

            try {
                await offlineStorage.init();

                // Get storage stats
                const stats = await offlineStorage.getStorageStats();
                const usagePercent = stats.usagePercent;
                let barClass = '';
                if (usagePercent > 90) barClass = 'critical';
                else if (usagePercent > 70) barClass = 'warning';

                statsEl.innerHTML = `
                    <p>Storage used: ${formatSize(stats.totalSizeKb)} of ~${formatSize(stats.quotaKb)}</p>
                    <div class="storage-bar">
                        <div class="storage-used ${barClass}" style="width: ${Math.min(usagePercent, 100)}%"></div>
                    </div>
                `;

                // Get saved routes
                const routes = await offlineStorage.getSavedRoutes();

                loadingEl.style.display = 'none';

                if (routes.length === 0) {
                    emptyEl.style.display = 'block';
                    return;
                }

                listEl.style.display = 'block';
                clearBtn.style.display = 'inline-block';

                console.log('Rendering routes:', routes);

                listEl.innerHTML = '';
                routes.forEach(function(route, index) {
                    console.log('Route ' + index + ' FULL DATA:', JSON.stringify(route, null, 2));

                    var routeName = route.name || 'Unnamed Route';
                    var routeDate = formatDate(route.savedAt);
                    var routeSize = formatSize(route.sizeKb || 0);
                    var routeUrl = encodeURIComponent(route.url);

                    // Check unit preference from localStorage
                    var imperial = localStorage.getItem('imperial') === 'true';

                    // Format stats with labels
                    var work = route.work_kj ? Math.round(route.work_kj) + ' kJ' : '-';
                    var time = route.time_seconds ? formatDuration(route.time_seconds) : '-';
                    var distance, elevation;
                    if (imperial) {
                        distance = route.distance_km ? (route.distance_km * 0.621371).toFixed(1) + ' mi' : '-';
                        elevation = route.elevation_m ? Math.round(route.elevation_m * 3.28084) + ' ft' : '-';
                    } else {
                        distance = route.distance_km ? route.distance_km.toFixed(1) + ' km' : '-';
                        elevation = route.elevation_m ? Math.round(route.elevation_m) + ' m' : '-';
                    }

                    // Format parameters info
                    var paramsInfo = '';
                    if (route.analysisParams) {
                        var p = route.analysisParams;
                        paramsInfo = (p.climbing_power || '?') + 'W/' + (p.flat_power || '?') + 'W, ' + (p.mass || '?') + 'kg';
                    }

                    var analyzeUrl = '/?url=' + routeUrl;
                    var html = '<li data-url="' + route.url + '" style="display:flex; justify-content:space-between; align-items:center; padding:16px 0; border-bottom:1px solid #eee;">' +
                        '<div style="flex:1; min-width:0;">' +
                            '<div class="route-name">' +
                                '<a href="' + analyzeUrl + '">' + routeName + '</a>' +
                            '</div>' +
                            '<div style="display:flex; gap:16px; flex-wrap:wrap; font-size:0.85em; color:#555; margin-bottom:4px;">' +
                                '<span><strong>Work:</strong> ' + work + '</span>' +
                                '<span><strong>Time:</strong> ' + time + '</span>' +
                                '<span><strong>Dist:</strong> ' + distance + '</span>' +
                                '<span><strong>Elev:</strong> ' + elevation + '</span>' +
                            '</div>' +
                            '<div style="font-size:0.8em; color:#888;">Saved ' + routeDate + ' · ' + routeSize +
                                (paramsInfo ? ' · <span title="Climbing/Flat power, Mass">Params: ' + paramsInfo + '</span>' : '') +
                            '</div>' +
                        '</div>' +
                        '<button type="button" class="delete-btn" onclick="deleteRoute(\'' + route.url.replace(/'/g, "\\'") + '\')">Delete</button>' +
                    '</li>';

                    listEl.insertAdjacentHTML('beforeend', html);
                });

            } catch (e) {
                console.error('Failed to load saved routes:', e);
                loadingEl.innerHTML = `<p style="color: #c00;">Failed to load saved routes: ${e.message}</p>`;
            }
        }

        // Delete a single route
        async function deleteRoute(url) {
            if (!confirm('Remove this route from offline storage?')) return;

            try {
                await offlineStorage.deleteRoute(url);

                // Remove the list item from display
                var item = document.querySelector('#savedRoutesList li[data-url="' + url + '"]');
                if (item) {
                    item.remove();
                }

                // Check if list is now empty
                var list = document.getElementById('savedRoutesList');
                if (list.children.length === 0) {
                    list.style.display = 'none';
                    document.getElementById('emptyState').style.display = 'block';
                    document.getElementById('clearAllBtn').style.display = 'none';
                }

                // Refresh stats
                loadSavedRoutes();
            } catch (e) {
                alert('Failed to delete: ' + e.message);
            }
        }

        // Clear all saved data
        async function clearAllSaved() {
            if (!confirm('Delete all saved routes? This cannot be undone.')) return;

            try {
                await offlineStorage.clearAll();
                // Clear the list immediately
                document.getElementById('savedRoutesList').innerHTML = '';
                document.getElementById('savedRoutesList').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('clearAllBtn').style.display = 'none';
                // Refresh stats
                loadSavedRoutes();
            } catch (e) {
                alert('Failed to clear data: ' + e.message);
            }
        }

        // Initialize - handles both fresh page load and router navigation
        function initSavedRoutes() {
            // Wait for offlineStorage to be available
            if (typeof offlineStorage !== 'undefined') {
                loadSavedRoutes();
            } else {
                // Scripts are deferred, try again after a short delay
                setTimeout(initSavedRoutes, 100);
            }
        }

        // Run on DOMContentLoaded or immediately if already loaded (router navigation)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initSavedRoutes);
        } else {
            initSavedRoutes();
        }
    </script>
    </main>

    <div class="footer">
        <div class="footer-content">
            <div class="footer-links">
                <a href="https://github.com/sanmi/gpx-analyzer" target="_blank" data-no-router>Source Code</a>
                <a href="https://github.com/sanmi/gpx-analyzer/issues" target="_blank" data-no-router>Report a Bug</a>
            </div>
            <div class="footer-version">{{ version_date }} ({{ git_hash }}) · SW --</div>
            <div class="footer-copyright">© 2025 Frank San Miguel</div>
        </div>
    </div>
</body>
</html>
